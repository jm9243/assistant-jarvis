# 贾维斯 PC端开发规范

## 架构原则

- **前后端分离**: UI层(Tauri+React) 与 执行层(Python) 完全解耦
- **Sidecar模式**: Python引擎作为独立进程，通过IPC/HTTP通信
- **模块化**: 功能模块独立，低耦合高内聚

## 目录规范

### 前端 (frontend/)
```
src/
├── app/              # 应用入口
├── pages/            # 页面组件（一级路由）
├── components/       # 通用组件
│   ├── nodes/        # 工作流节点组件
│   └── common/       # 公共UI组件
├── stores/           # Zustand状态管理
├── services/         # API服务层
├── hooks/            # 自定义Hooks
├── utils/            # 工具函数
└── types/            # TypeScript类型
```

### 后端 (engine/)
```
├── main.py           # 入口文件
├── api/              # FastAPI服务
├── core/             # 核心引擎
│   ├── workflow/     # 工作流引擎
│   ├── agent/        # Agent系统
│   ├── recorder/     # 录制器
│   └── call/         # 通话系统
├── tools/            # 工具集
│   ├── gui/          # GUI自动化
│   ├── web/          # Web自动化
│   ├── system/       # 系统集成
│   └── ai/           # AI服务
├── utils/            # 工具函数
└── models/           # 数据模型
```

## 命名规范

### 文件命名
- React组件: `PascalCase.tsx` (如 `WorkflowDesigner.tsx`)
- TypeScript文件: `camelCase.ts` (如 `workflowStore.ts`)
- Python文件: `snake_case.py` (如 `workflow_executor.py`)

### 变量命名
- 组件/类: `PascalCase`
- 变量/函数: `camelCase` (TS) / `snake_case` (Python)
- 常量: `UPPER_SNAKE_CASE`
- 接口: `I` 前缀 (如 `IWorkflow`)
- 类型: `T` 前缀 (如 `TNodeType`)

## 代码规范

### TypeScript
```typescript
// 使用箭头函数
const MyComponent: React.FC<Props> = ({ data }) => {
  // 使用Hooks
  const [state, setState] = useState(0);
  
  // 提前返回
  if (!data) return null;
  
  return <div>{data}</div>;
};

// 类型定义
interface IWorkflow {
  id: string;
  name: string;
  nodes: INode[];
}

// 使用枚举
enum NodeType {
  Click = 'click',
  Input = 'input'
}
```

### Python
```python
# 类型注解
def execute_workflow(workflow: Workflow, params: dict) -> Result:
    """执行工作流
    
    Args:
        workflow: 工作流定义
        params: 执行参数
        
    Returns:
        执行结果
    """
    pass

# 使用dataclass
from dataclasses import dataclass

@dataclass
class Node:
    id: str
    type: str
    config: dict
```

## 通信规范

### 前端调用后端
```typescript
// Tauri命令
import { invoke } from '@tauri-apps/api/tauri';

const result = await invoke('execute_workflow', {
  workflowId: 'xxx',
  params: {}
});
```

### 后端事件推送
```python
# WebSocket推送
websocket.emit('workflow_status', {
    'status': 'running',
    'progress': 50
})
```

## 状态管理

### Zustand Store
```typescript
interface WorkflowStore {
  workflows: IWorkflow[];
  currentWorkflow: IWorkflow | null;
  
  // Actions
  addWorkflow: (workflow: IWorkflow) => void;
  updateWorkflow: (id: string, updates: Partial<IWorkflow>) => void;
}

const useWorkflowStore = create<WorkflowStore>((set) => ({
  workflows: [],
  currentWorkflow: null,
  
  addWorkflow: (workflow) => 
    set((state) => ({ workflows: [...state.workflows, workflow] })),
  
  updateWorkflow: (id, updates) =>
    set((state) => ({
      workflows: state.workflows.map(w => 
        w.id === id ? { ...w, ...updates } : w
      )
    }))
}));
```

## 错误处理

### 前端
```typescript
try {
  const result = await invoke('execute_workflow', params);
} catch (error) {
  console.error('执行失败:', error);
  toast.error(error.message);
}
```

### 后端
```python
from typing import Optional

class WorkflowError(Exception):
    """工作流执行错误"""
    pass

def execute_node(node: Node) -> Result:
    try:
        return node.execute()
    except Exception as e:
        logger.error(f"节点执行失败: {e}")
        raise WorkflowError(f"节点 {node.id} 执行失败") from e
```

## 性能优化

- 使用 `React.memo` 避免不必要的渲染
- 大列表使用虚拟滚动 (react-window)
- 使用 `useMemo` / `useCallback` 缓存计算结果
- Python使用异步IO (`async/await`)
- 批量操作减少API调用

## 日志规范

### 前端
```typescript
import { info, error } from '@tauri-apps/api/log';

await info('工作流执行开始');
await error('执行失败', error);
```

### 后端
```python
import logging

logger = logging.getLogger(__name__)

logger.info('工作流执行开始')
logger.error('执行失败', exc_info=True)
```

## 测试规范

### 单元测试
- 前端: Vitest + React Testing Library
- 后端: pytest

### 集成测试
- 关键流程必须有集成测试
- 模拟真实场景

## Git提交规范

使用 Conventional Commits:

```
<type>(<scope>): <subject>

feat(workflow): 添加节点复制功能
fix(agent): 修复内存泄漏问题
docs(api): 更新API文档
style(ui): 调整按钮样式
refactor(core): 重构执行引擎
test(workflow): 添加执行器测试
chore(deps): 更新依赖版本
```

## 安全规范

- **敏感数据加密**: 使用系统密钥库存储API Key
- **输入验证**: 所有外部输入必须验证
- **权限检查**: 操作前检查权限
- **审计日志**: 记录关键操作
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 转义用户输入

## 关键约束

- 前端启动时间 < 3秒
- 后端内存占用 < 500MB (执行时)
- UI操作响应 < 100ms
- API响应 < 200ms (P95)
- 跨平台代码复用率 > 80%

---

**原则**: 简洁、清晰、可维护。遵循规范，保持一致性。

