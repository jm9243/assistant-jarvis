# 贾维斯架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    前端 (React + Tauri)                      │
│  - 用户界面                                                   │
│  - 状态管理 (Zustand)                                        │
│  - 路由管理                                                   │
└────────────┬────────────────────────────┬───────────────────┘
             │                            │
             │ HTTP                       │ IPC (stdin/stdout)
             ↓                            ↓
┌────────────────────────┐    ┌──────────────────────────────┐
│   云服务 (Go 后台)      │    │   本地引擎 (Python Daemon)    │
│  - 用户认证 (Clerk)     │    │  - Agent 管理                │
│  - 会话管理            │    │  - 知识库管理                │
│  - Agent 模板          │    │  - 工具管理                  │
│  - 大模型 API 代理     │    │  - 工作流执行                │
│  - 数据同步            │    │  - 录制器                    │
└────────────────────────┘    └──────────────────────────────┘
             │                            │
             │                            │
             ↓                            ↓
┌────────────────────────┐    ┌──────────────────────────────┐
│   PostgreSQL           │    │   本地存储                    │
│  - 用户数据            │    │  - JSON 数据库               │
│  - 会话数据            │    │  - 向量数据库 (Chroma)       │
│  - Agent 配置          │    │  - 日志文件                  │
└────────────────────────┘    └──────────────────────────────┘
```

## 功能分工

### 云服务负责

#### 1. 用户认证和授权
- 登录/注册
- Token 管理
- 权限控制

#### 2. 会话管理
- 创建会话
- 删除会话
- 重命名会话
- 会话列表同步

#### 3. Agent 模板
- 模板市场
- 模板分享
- 模板导入/导出

#### 4. 大模型 API
- OpenAI API 代理
- Claude API 代理
- 其他 LLM API
- API Key 管理

#### 5. 数据同步
- 跨设备同步
- 云端备份
- 数据恢复

### 本地引擎负责

#### 1. Agent 管理（本地）
- Agent CRUD 操作
- Agent 配置存储
- Agent 状态管理

#### 2. 知识库管理
- 文档上传和解析
- 向量化和存储
- 语义检索
- 知识库统计

#### 3. 工具管理
- 工具注册
- 工具调用
- 工具权限控制
- 工具使用统计

#### 4. 工作流执行
- 工作流解析
- 节点执行
- 状态管理
- 错误处理

#### 5. 录制器
- 操作录制
- 动作识别
- 工作流生成

#### 6. 对话处理
- 消息本地缓存
- 对话历史管理
- 上下文管理

## 数据流

### 对话流程

```
用户输入消息
    ↓
前端 (ChatPage)
    ↓
Python 引擎 (agent_chat)
    ↓
云服务 (LLM API)
    ↓
Python 引擎 (处理响应)
    ↓
前端 (显示消息)
    ↓
云服务 (保存会话)
```

### Agent 创建流程

```
用户填写表单
    ↓
前端 (AgentFormPage)
    ↓
Tauri 命令 (create_agent)
    ↓
Python IPC (create_agent)
    ↓
本地数据库 (保存)
    ↓
返回 Agent ID
    ↓
前端 (跳转到列表)
```

### 知识库检索流程

```
用户提问
    ↓
Python 引擎 (agent_chat)
    ↓
知识库检索 (kb_search)
    ↓
向量数据库 (Chroma)
    ↓
返回相关文档
    ↓
LLM 生成回答
    ↓
返回给用户
```

## 为什么需要两个后端？

### 云服务的优势
1. **大模型 API 调用**
   - 需要 API Key 管理
   - 需要请求代理和缓存
   - 需要成本控制

2. **数据同步**
   - 跨设备访问
   - 云端备份
   - 团队协作

3. **用户管理**
   - 统一认证
   - 权限控制
   - 订阅管理

### 本地引擎的优势
1. **隐私保护**
   - 敏感数据本地存储
   - 不上传到云端
   - 完全离线可用

2. **性能优化**
   - 本地缓存
   - 快速响应
   - 减少网络延迟

3. **功能扩展**
   - GUI 自动化
   - 本地工具调用
   - 系统集成

## 通信协议

### HTTP (前端 ↔ 云服务)
- REST API
- JSON 格式
- JWT 认证

### IPC (前端 ↔ 本地引擎)
- Tauri 命令
- stdin/stdout
- JSON-RPC 格式

### 示例

#### HTTP 请求
```typescript
// 登录
POST http://localhost:8080/api/v1/auth/login
{
  "email": "user@example.com",
  "password": "password"
}
```

#### IPC 请求
```typescript
// 创建 Agent
invoke('create_agent', {
  name: 'My Agent',
  type: 'basic',
  llmConfig: {...}
})
```

## 部署架构

### 开发环境
```
本地机器
├── 前端 (Tauri Dev Server) - localhost:1420
├── 云服务 (Go) - localhost:8080
└── Python 引擎 (Daemon) - IPC
```

### 生产环境
```
用户设备
├── 桌面应用 (Tauri)
│   ├── 前端 (打包)
│   └── Python 引擎 (打包)
└── 网络连接
    └── 云服务 (部署在服务器)
```

## 数据存储

### 云端 (PostgreSQL)
- 用户账号
- 会话记录
- Agent 模板
- 订阅信息

### 本地 (JSON + Chroma)
- Agent 配置
- 知识库文档
- 工具配置
- 工作流定义
- 对话缓存

## 安全性

### 云服务
- HTTPS 加密
- JWT Token
- API Key 加密存储
- 请求限流

### 本地引擎
- 系统密钥库 (Keychain)
- 本地数据加密
- 进程隔离
- 权限控制

## 总结

这种混合架构结合了云服务和本地引擎的优势：
- ✅ 云服务提供大模型能力和数据同步
- ✅ 本地引擎保护隐私和提升性能
- ✅ 两者协同工作，提供完整的功能体验
