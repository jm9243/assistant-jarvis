# æµ‹è¯•æŒ‡å—

æœ¬æ–‡æ¡£æä¾›åç«¯æœåŠ¡çš„æµ‹è¯•æŒ‡å—ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ç­‰ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æµ‹è¯•æ¡†æ¶](#æµ‹è¯•æ¡†æ¶)
2. [å•å…ƒæµ‹è¯•](#å•å…ƒæµ‹è¯•)
3. [é›†æˆæµ‹è¯•](#é›†æˆæµ‹è¯•)
4. [æ€§èƒ½æµ‹è¯•](#æ€§èƒ½æµ‹è¯•)
5. [æµ‹è¯•è¦†ç›–ç‡](#æµ‹è¯•è¦†ç›–ç‡)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æµ‹è¯•æ¡†æ¶

### ä½¿ç”¨çš„æµ‹è¯•å·¥å…·

| å·¥å…· | ç”¨é€” | å®‰è£… |
|------|------|------|
| testing | Go æ ‡å‡†æµ‹è¯•åº“ | å†…ç½® |
| testify | æ–­è¨€å’Œ Mock | `go get github.com/stretchr/testify` |
| httptest | HTTP æµ‹è¯• | å†…ç½® |

### å®‰è£…ä¾èµ–

```bash
# å®‰è£… testify
go get github.com/stretchr/testify/assert
go get github.com/stretchr/testify/mock
go get github.com/stretchr/testify/suite

# æ›´æ–°ä¾èµ–
go mod tidy
```

---

## å•å…ƒæµ‹è¯•

### æµ‹è¯•ç»“æ„

```
internal/
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ user_service.go
â”‚   â””â”€â”€ user_service_test.go      # å•å…ƒæµ‹è¯•
â”œâ”€â”€ repository/
â”‚   â”œâ”€â”€ user_repo.go
â”‚   â””â”€â”€ user_repo_test.go         # å•å…ƒæµ‹è¯•
â””â”€â”€ handler/
    â”œâ”€â”€ user_handler.go
    â””â”€â”€ user_handler_test.go      # å•å…ƒæµ‹è¯•
```

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
make test-unit

# æˆ–è€…
go test -v -short ./internal/service/... ./internal/repository/...

# è¿è¡Œç‰¹å®šåŒ…çš„æµ‹è¯•
go test -v ./internal/service

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
go test -v -run TestGetUserByID ./internal/service
```

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```go
// internal/service/user_service_test.go
package service

import (
	"context"
	"testing"
	"time"

	"github.com/assistant-jarvis/backend/internal/model"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
)

// MockUserRepository æ¨¡æ‹Ÿ UserRepository
type MockUserRepository struct {
	mock.Mock
}

func (m *MockUserRepository) FindByID(ctx context.Context, userID string) (*model.User, error) {
	args := m.Called(ctx, userID)
	if args.Get(0) == nil {
		return nil, args.Error(1)
	}
	return args.Get(0).(*model.User), args.Error(1)
}

// TestGetUserByID æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
func TestGetUserByID(t *testing.T) {
	// å‡†å¤‡
	mockRepo := new(MockUserRepository)
	mockCache := new(MockRedisCache)
	service := NewUserService(mockRepo, mockCache)

	userID := "test-user-id"
	expectedUser := &model.User{
		ID:       userID,
		Username: "testuser",
	}

	ctx := context.Background()
	mockRepo.On("FindByID", ctx, userID).Return(expectedUser, nil)
	mockCache.On("Set", ctx, "user:"+userID, expectedUser, 30*time.Minute).Return(nil)

	// æ‰§è¡Œ
	user, err := service.GetUserByID(ctx, userID)

	// æ–­è¨€
	assert.NoError(t, err)
	assert.NotNil(t, user)
	assert.Equal(t, userID, user.ID)

	// éªŒè¯ Mock è°ƒç”¨
	mockRepo.AssertExpectations(t)
}
```

---

## é›†æˆæµ‹è¯•

### æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ api_test.go           # API é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ auth_test.go          # è®¤è¯é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ workflow_test.go      # å·¥ä½œæµé›†æˆæµ‹è¯•
â””â”€â”€ e2e/
    â””â”€â”€ user_flow_test.go     # ç«¯åˆ°ç«¯æµ‹è¯•
```

### è¿è¡Œé›†æˆæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
make test-integration

# æˆ–è€…
go test -v -run Integration ./...

# è¿è¡Œ E2E æµ‹è¯•
go test -v ./tests/e2e/...
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹

```go
// tests/integration/api_test.go
package integration

import (
	"bytes"
	"encoding/json"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/assistant-jarvis/backend/cmd/server"
	"github.com/stretchr/testify/assert"
)

func TestIntegrationHealthCheck(t *testing.T) {
	if testing.Short() {
		t.Skip("è·³è¿‡é›†æˆæµ‹è¯•")
	}

	// åˆ›å»ºæµ‹è¯•æœåŠ¡å™¨
	router := server.SetupRouter()
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/health", nil)

	// æ‰§è¡Œè¯·æ±‚
	router.ServeHTTP(w, req)

	// æ–­è¨€
	assert.Equal(t, 200, w.Code)
	
	var response map[string]interface{}
	json.Unmarshal(w.Body.Bytes(), &response)
	assert.Equal(t, "ok", response["status"])
}

func TestIntegrationUserRegistration(t *testing.T) {
	if testing.Short() {
		t.Skip("è·³è¿‡é›†æˆæµ‹è¯•")
	}

	router := server.SetupRouter()

	// å‡†å¤‡æ³¨å†Œæ•°æ®
	registerData := map[string]string{
		"email":    "test@example.com",
		"password": "password123",
		"username": "testuser",
	}
	jsonData, _ := json.Marshal(registerData)

	w := httptest.NewRecorder()
	req, _ := http.NewRequest("POST", "/api/v1/auth/register", bytes.NewBuffer(jsonData))
	req.Header.Set("Content-Type", "application/json")

	// æ‰§è¡Œè¯·æ±‚
	router.ServeHTTP(w, req)

	// æ–­è¨€
	assert.Equal(t, 200, w.Code)
	
	var response map[string]interface{}
	json.Unmarshal(w.Body.Bytes(), &response)
	assert.True(t, response["success"].(bool))
}
```

---

## æ€§èƒ½æµ‹è¯•

### è¿è¡Œæ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æ€§èƒ½æµ‹è¯•
make bench

# æˆ–è€…
go test -bench=. -benchmem ./...

# è¿è¡Œç‰¹å®šåŒ…çš„æ€§èƒ½æµ‹è¯•
go test -bench=. -benchmem ./internal/service

# ç”Ÿæˆæ€§èƒ½åˆ†æ
go test -bench=. -cpuprofile=cpu.prof -memprofile=mem.prof ./internal/service

# æŸ¥çœ‹ CPU åˆ†æ
go tool pprof cpu.prof

# æŸ¥çœ‹å†…å­˜åˆ†æ
go tool pprof mem.prof
```

### æ€§èƒ½æµ‹è¯•ç¤ºä¾‹

```go
// internal/service/user_service_test.go
func BenchmarkGetUserByID(b *testing.B) {
	mockRepo := new(MockUserRepository)
	mockCache := new(MockRedisCache)
	service := NewUserService(mockRepo, mockCache)

	userID := "test-user-id"
	user := &model.User{
		ID:       userID,
		Username: "testuser",
	}

	ctx := context.Background()
	mockRepo.On("FindByID", ctx, userID).Return(user, nil)
	mockCache.On("Set", ctx, mock.Anything, mock.Anything, mock.Anything).Return(nil)

	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		_, _ = service.GetUserByID(ctx, userID)
	}
}

func BenchmarkWorkflowCreate(b *testing.B) {
	// æ€§èƒ½æµ‹è¯•å·¥ä½œæµåˆ›å»º
	// ...
}
```

### æ€§èƒ½æµ‹è¯•ç»“æœç¤ºä¾‹

```
BenchmarkGetUserByID-8          1000000         1234 ns/op         512 B/op        8 allocs/op
BenchmarkWorkflowCreate-8       500000          2345 ns/op        1024 B/op       16 allocs/op
```

è§£è¯»ï¼š
- `1000000`: æ‰§è¡Œæ¬¡æ•°
- `1234 ns/op`: æ¯æ¬¡æ“ä½œå¹³å‡è€—æ—¶ï¼ˆçº³ç§’ï¼‰
- `512 B/op`: æ¯æ¬¡æ“ä½œå¹³å‡å†…å­˜åˆ†é…ï¼ˆå­—èŠ‚ï¼‰
- `8 allocs/op`: æ¯æ¬¡æ“ä½œå¹³å‡å†…å­˜åˆ†é…æ¬¡æ•°

---

## æµ‹è¯•è¦†ç›–ç‡

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
make test-cover

# æˆ–è€…
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# æŸ¥çœ‹è¦†ç›–ç‡ç»Ÿè®¡
go tool cover -func=coverage.out
```

### æŸ¥çœ‹è¦†ç›–ç‡

```bash
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¦†ç›–ç‡æŠ¥å‘Š
open coverage.html

# æˆ–æŸ¥çœ‹å‘½ä»¤è¡Œç»Ÿè®¡
go tool cover -func=coverage.out

# è¾“å‡ºç¤ºä¾‹ï¼š
# github.com/assistant-jarvis/backend/internal/service/user_service.go:15:    NewUserService          100.0%
# github.com/assistant-jarvis/backend/internal/service/user_service.go:22:    GetUserByID             85.7%
# github.com/assistant-jarvis/backend/internal/service/user_service.go:45:    UpdateUser              90.0%
# total:                                                                          (statements)   80.5%
```

### è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ |
|------|-----------|
| Service å±‚ | â‰¥ 85% |
| Repository å±‚ | â‰¥ 80% |
| Handler å±‚ | â‰¥ 75% |
| Utils å·¥å…· | â‰¥ 90% |
| **æ€»ä½“** | **â‰¥ 80%** |

---

## æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½åè§„èŒƒ

```go
// æµ‹è¯•å‡½æ•°å‘½åï¼šTest + å‡½æ•°å + åœºæ™¯
func TestGetUserByID_Success(t *testing.T) {}
func TestGetUserByID_UserNotFound(t *testing.T) {}
func TestGetUserByID_DatabaseError(t *testing.T) {}

// æ€§èƒ½æµ‹è¯•å‘½åï¼šBenchmark + å‡½æ•°å
func BenchmarkGetUserByID(b *testing.B) {}
```

### 2. ä½¿ç”¨ Table-Driven Tests

```go
func TestValidateEmail(t *testing.T) {
	tests := []struct {
		name    string
		email   string
		wantErr bool
	}{
		{"valid email", "test@example.com", false},
		{"invalid email", "invalid", true},
		{"empty email", "", true},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			err := ValidateEmail(tt.email)
			if (err != nil) != tt.wantErr {
				t.Errorf("ValidateEmail() error = %v, wantErr %v", err, tt.wantErr)
			}
		})
	}
}
```

### 3. ä½¿ç”¨ Mock éš”ç¦»ä¾èµ–

```go
// ä½¿ç”¨ testify/mock åˆ›å»º Mock å¯¹è±¡
type MockRepository struct {
	mock.Mock
}

func (m *MockRepository) FindByID(ctx context.Context, id string) (*model.User, error) {
	args := m.Called(ctx, id)
	return args.Get(0).(*model.User), args.Error(1)
}

// åœ¨æµ‹è¯•ä¸­ä½¿ç”¨
mockRepo := new(MockRepository)
mockRepo.On("FindByID", ctx, "user-id").Return(expectedUser, nil)
```

### 4. æ¸…ç†æµ‹è¯•æ•°æ®

```go
func TestWithCleanup(t *testing.T) {
	// åˆ›å»ºæµ‹è¯•æ•°æ®
	testData := setupTestData()

	// æ³¨å†Œæ¸…ç†å‡½æ•°
	t.Cleanup(func() {
		cleanupTestData(testData)
	})

	// æ‰§è¡Œæµ‹è¯•
	// ...
}
```

### 5. ä½¿ç”¨ Subtests

```go
func TestUserService(t *testing.T) {
	t.Run("GetUserByID", func(t *testing.T) {
		// æµ‹è¯• GetUserByID
	})

	t.Run("UpdateUser", func(t *testing.T) {
		// æµ‹è¯• UpdateUser
	})
}
```

---

## æŒç»­é›†æˆ (CI)

### GitHub Actions é…ç½®ç¤ºä¾‹

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install dependencies
        run: |
          cd backend
          go mod download
      
      - name: Run tests
        run: |
          cd backend
          make test-cover
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.out
```

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼Ÿ

ä½¿ç”¨ `-short` æ ‡å¿—ï¼š

```go
func TestSlowOperation(t *testing.T) {
	if testing.Short() {
		t.Skip("è·³è¿‡æ…¢é€Ÿæµ‹è¯•")
	}
	// æ…¢é€Ÿæµ‹è¯•ä»£ç 
}

// è¿è¡Œæ—¶è·³è¿‡
go test -short ./...
```

### Q2: å¦‚ä½•å¹¶è¡Œè¿è¡Œæµ‹è¯•ï¼Ÿ

```go
func TestParallel(t *testing.T) {
	t.Parallel() // æ ‡è®°ä¸ºå¹¶è¡Œæµ‹è¯•

	// æµ‹è¯•ä»£ç 
}

// æˆ–ä½¿ç”¨ -parallel æ ‡å¿—
go test -parallel 4 ./...
```

### Q3: å¦‚ä½•æµ‹è¯• HTTP Handlerï¼Ÿ

```go
func TestUserHandler(t *testing.T) {
	router := gin.New()
	handler := NewUserHandler(mockService)
	router.GET("/users/:id", handler.GetByID)

	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/users/123", nil)
	router.ServeHTTP(w, req)

	assert.Equal(t, 200, w.Code)
}
```

---

## æµ‹è¯•æ¸…å•

ä½¿ç”¨ä»¥ä¸‹æ¸…å•ç¡®ä¿æµ‹è¯•å®Œæ•´æ€§ï¼š

- [ ] æ‰€æœ‰ Service å±‚å‡½æ•°æœ‰å•å…ƒæµ‹è¯•
- [ ] æ‰€æœ‰ Repository å±‚å‡½æ•°æœ‰å•å…ƒæµ‹è¯•
- [ ] æ‰€æœ‰ Handler å±‚å‡½æ•°æœ‰å•å…ƒæµ‹è¯•
- [ ] å…³é”®ä¸šåŠ¡é€»è¾‘æœ‰é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½å…³é”®è·¯å¾„æœ‰æ€§èƒ½æµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] æ‰€æœ‰æµ‹è¯•éƒ½èƒ½é€šè¿‡
- [ ] CI/CD é…ç½®æ­£ç¡®

---

## å‚è€ƒèµ„æ–™

- [Go Testing å®˜æ–¹æ–‡æ¡£](https://pkg.go.dev/testing)
- [Testify æ–‡æ¡£](https://github.com/stretchr/testify)
- [Go Testing Best Practices](https://go.dev/doc/tutorial/add-a-test)

---

**æœ€åæ›´æ–°**: 2025-11-08

