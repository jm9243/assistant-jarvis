# æ€§èƒ½ä¼˜åŒ–æŒ‡å—

æœ¬æ–‡æ¡£æä¾›åç«¯æœåŠ¡çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å’Œæœ€ä½³å®è·µã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ€§èƒ½ç›®æ ‡](#æ€§èƒ½ç›®æ ‡)
2. [æ•°æ®åº“ä¼˜åŒ–](#æ•°æ®åº“ä¼˜åŒ–)
3. [ç¼“å­˜ç­–ç•¥](#ç¼“å­˜ç­–ç•¥)
4. [å¹¶å‘ä¼˜åŒ–](#å¹¶å‘ä¼˜åŒ–)
5. [å†…å­˜ä¼˜åŒ–](#å†…å­˜ä¼˜åŒ–)
6. [ç½‘ç»œä¼˜åŒ–](#ç½‘ç»œä¼˜åŒ–)
7. [ç›‘æ§ä¸åˆ†æ](#ç›‘æ§ä¸åˆ†æ)

---

## æ€§èƒ½ç›®æ ‡

### API å“åº”æ—¶é—´ç›®æ ‡

| API ç±»å‹ | P50 | P95 | P99 |
|----------|-----|-----|-----|
| ç®€å•æŸ¥è¯¢ | < 50ms | < 100ms | < 200ms |
| å¤æ‚æŸ¥è¯¢ | < 100ms | < 200ms | < 500ms |
| å†™å…¥æ“ä½œ | < 80ms | < 150ms | < 300ms |
| æ–‡ä»¶ä¸Šä¼  | < 1s (10MB) | < 2s | < 5s |

### å¹¶å‘æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|--------|
| QPS | > 1000 |
| å¹¶å‘è¿æ¥ | > 5000 |
| WebSocket è¿æ¥ | > 10000 |
| é”™è¯¯ç‡ | < 0.1% |

---

## æ•°æ®åº“ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–

#### å·²å®ç°çš„ç´¢å¼•

```sql
-- workflows è¡¨
CREATE INDEX idx_workflows_user_id ON public.workflows(user_id);
CREATE INDEX idx_workflows_category ON public.workflows(category);
CREATE INDEX idx_workflows_tags ON public.workflows USING GIN(tags);
CREATE INDEX idx_workflows_user_category ON public.workflows(user_id, category);

-- tasks è¡¨
CREATE INDEX idx_tasks_workflow_id ON public.tasks(workflow_id);
CREATE INDEX idx_tasks_user_id ON public.tasks(user_id);
CREATE INDEX idx_tasks_status ON public.tasks(status);
CREATE INDEX idx_tasks_created_at ON public.tasks(created_at DESC);
```

#### ç´¢å¼•ä¼˜åŒ–å»ºè®®

1. **å¤åˆç´¢å¼•**: å°†å¸¸ç”¨çš„æŸ¥è¯¢æ¡ä»¶ç»„åˆæˆå¤åˆç´¢å¼•
2. **è¦†ç›–ç´¢å¼•**: åŒ…å«æ‰€æœ‰æŸ¥è¯¢å­—æ®µçš„ç´¢å¼•ï¼Œé¿å…å›è¡¨
3. **éƒ¨åˆ†ç´¢å¼•**: åªç´¢å¼•ç‰¹å®šæ¡ä»¶çš„æ•°æ®

```sql
-- éƒ¨åˆ†ç´¢å¼•ç¤ºä¾‹ï¼šåªç´¢å¼•è¿›è¡Œä¸­çš„ä»»åŠ¡
CREATE INDEX idx_tasks_running ON public.tasks(created_at) 
WHERE status IN ('pending', 'running');
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

#### é¿å… N+1 æŸ¥è¯¢

**âŒ ä¸å¥½çš„åšæ³•**:
```go
workflows, _ := repo.FindByUserID(ctx, userID)
for _, workflow := range workflows {
    tasks, _ := taskRepo.FindByWorkflowID(ctx, workflow.ID)
    // æ¯ä¸ªå·¥ä½œæµéƒ½æŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“
}
```

**âœ… å¥½çš„åšæ³•**:
```go
workflows, _ := repo.FindByUserID(ctx, userID)
workflowIDs := extractIDs(workflows)
tasks, _ := taskRepo.FindByWorkflowIDs(ctx, workflowIDs) // ä¸€æ¬¡æŸ¥è¯¢
taskMap := groupByWorkflowID(tasks)
```

#### ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥

```go
// ä½¿ç”¨ pgx çš„ prepared statements
stmt, err := conn.Prepare(ctx, "get-user", "SELECT * FROM users WHERE id = $1")
// é‡å¤ä½¿ç”¨
user, err := conn.QueryRow(ctx, "get-user", userID).Scan(...)
```

#### åˆ†é¡µä¼˜åŒ–

```go
// ä½¿ç”¨ LIMIT + OFFSETï¼ˆé€‚ç”¨äºå°æ•°æ®é‡ï¼‰
SELECT * FROM tasks ORDER BY created_at DESC LIMIT 20 OFFSET 0;

// ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆé€‚ç”¨äºå¤§æ•°æ®é‡ï¼‰
SELECT * FROM tasks WHERE created_at < $1 ORDER BY created_at DESC LIMIT 20;
```

### 3. è¿æ¥æ± é…ç½®

```go
// æ¨èé…ç½®
config.MaxConns = 20              // æœ€å¤§è¿æ¥æ•°
config.MinConns = 5               // æœ€å°è¿æ¥æ•°
config.MaxConnLifetime = time.Hour // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
config.MaxConnIdleTime = 30 * time.Minute // ç©ºé—²è¿æ¥è¶…æ—¶
config.HealthCheckPeriod = 1 * time.Minute // å¥åº·æ£€æŸ¥å‘¨æœŸ
```

---

## ç¼“å­˜ç­–ç•¥

### 1. ç¼“å­˜å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°ç¼“å­˜ (map/sync.Map)             â”‚
â”‚  - çƒ­ç‚¹æ•°æ®                          â”‚
â”‚  - TTL: 1-5 åˆ†é’Ÿ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ Miss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis ç¼“å­˜                          â”‚
â”‚  - ç”¨æˆ·ä¿¡æ¯ã€å·¥ä½œæµè¯¦æƒ…               â”‚
â”‚  - TTL: 5-30 åˆ†é’Ÿ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ Miss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“ (PostgreSQL)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç¼“å­˜ç­–ç•¥

#### Cache-Aside Pattern (å·²å®ç°)

```go
func (s *UserService) GetUserByID(ctx context.Context, userID string) (*model.User, error) {
	// 1. å°è¯•ä»ç¼“å­˜è·å–
	cacheKey := fmt.Sprintf("user:%s", userID)
	cached, err := s.cache.Get(ctx, cacheKey)
	if err == nil && cached != nil {
		return cached.(*model.User), nil
	}

	// 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
	user, err := s.userRepo.FindByID(ctx, userID)
	if err != nil {
		return nil, err
	}

	// 3. å†™å…¥ç¼“å­˜
	_ = s.cache.Set(ctx, cacheKey, user, 30*time.Minute)

	return user, nil
}
```

#### ç¼“å­˜ Key è®¾è®¡

```go
// ç”¨æˆ·ä¿¡æ¯
"user:{user_id}"

// å·¥ä½œæµè¯¦æƒ…
"workflow:{workflow_id}"

// å·¥ä½œæµåˆ—è¡¨ï¼ˆå¸¦å‚æ•°ï¼‰
"workflows:user:{user_id}:category:{category}:page:{page}"

// ä»»åŠ¡ç»Ÿè®¡
"task:stats:user:{user_id}:workflow:{workflow_id}"
```

#### ç¼“å­˜ TTL å»ºè®®

| æ•°æ®ç±»å‹ | TTL | åŸå›  |
|---------|-----|------|
| ç”¨æˆ·ä¿¡æ¯ | 30åˆ†é’Ÿ | å˜æ›´é¢‘ç‡ä½ |
| å·¥ä½œæµè¯¦æƒ… | 5åˆ†é’Ÿ | å¯èƒ½è¢«ç¼–è¾‘ |
| ä»»åŠ¡åˆ—è¡¨ | 1åˆ†é’Ÿ | å®æ—¶æ€§è¦æ±‚é«˜ |
| ç»Ÿè®¡æ•°æ® | 10åˆ†é’Ÿ | å…è®¸ä¸€å®šå»¶è¿Ÿ |

### 3. ç¼“å­˜å¤±æ•ˆç­–ç•¥

```go
// å†™æ“ä½œæ—¶ä¸»åŠ¨å¤±æ•ˆ
func (s *UserService) UpdateUser(ctx context.Context, userID string, req *model.UpdateUserRequest) error {
	// æ›´æ–°æ•°æ®åº“
	if err := s.userRepo.Update(ctx, userID, req); err != nil {
		return err
	}

	// åˆ é™¤ç¼“å­˜
	cacheKey := fmt.Sprintf("user:%s", userID)
	_ = s.cache.Delete(ctx, cacheKey)

	return nil
}

// æ‰¹é‡å¤±æ•ˆï¼ˆé€šé…ç¬¦ï¼‰
func (s *WorkflowService) DeleteWorkflow(ctx context.Context, workflowID string) error {
	// åˆ é™¤æ•°æ®åº“
	if err := s.workflowRepo.Delete(ctx, workflowID); err != nil {
		return err
	}

	// åˆ é™¤ç›¸å…³ç¼“å­˜
	_ = s.cache.DeletePattern(ctx, fmt.Sprintf("workflow:%s*", workflowID))
	_ = s.cache.DeletePattern(ctx, "workflows:*") // æ¸…é™¤åˆ—è¡¨ç¼“å­˜

	return nil
}
```

---

## å¹¶å‘ä¼˜åŒ–

### 1. Goroutine æ± 

```go
// ä½¿ç”¨ worker pool é™åˆ¶å¹¶å‘æ•°
type WorkerPool struct {
	maxWorkers int
	jobs       chan func()
}

func NewWorkerPool(maxWorkers int) *WorkerPool {
	pool := &WorkerPool{
		maxWorkers: maxWorkers,
		jobs:       make(chan func(), 100),
	}
	
	for i := 0; i < maxWorkers; i++ {
		go pool.worker()
	}
	
	return pool
}

func (p *WorkerPool) Submit(job func()) {
	p.jobs <- job
}
```

### 2. æ‰¹é‡æ“ä½œ

```go
// æ‰¹é‡æ’å…¥æ—¥å¿—
func (s *LogService) BatchCreateLogs(ctx context.Context, logs []*model.Log) error {
	const batchSize = 100
	
	for i := 0; i < len(logs); i += batchSize {
		end := i + batchSize
		if end > len(logs) {
			end = len(logs)
		}
		
		batch := logs[i:end]
		if err := s.logRepo.BatchCreate(ctx, batch); err != nil {
			return err
		}
	}
	
	return nil
}
```

### 3. å¹¶å‘æ§åˆ¶

```go
// ä½¿ç”¨ semaphore æ§åˆ¶å¹¶å‘
import "golang.org/x/sync/semaphore"

sem := semaphore.NewWeighted(10) // æœ€å¤š10ä¸ªå¹¶å‘

for _, task := range tasks {
	if err := sem.Acquire(ctx, 1); err != nil {
		return err
	}
	
	go func(t *Task) {
		defer sem.Release(1)
		processTask(t)
	}(task)
}
```

---

## å†…å­˜ä¼˜åŒ–

### 1. é¿å…å†…å­˜æ³„æ¼

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ sync.Pool å¤ç”¨å¯¹è±¡
var bufferPool = sync.Pool{
	New: func() interface{} {
		return new(bytes.Buffer)
	},
}

func ProcessData(data []byte) {
	buf := bufferPool.Get().(*bytes.Buffer)
	defer bufferPool.Put(buf)
	
	buf.Reset()
	buf.Write(data)
	// å¤„ç†æ•°æ®
}
```

### 2. å‡å°‘å†…å­˜åˆ†é…

```go
// âŒ ä¸å¥½ï¼šé¢‘ç¹åˆ›å»ºå­—ç¬¦ä¸²
func buildKey(userID, resourceID string) string {
	return "user:" + userID + ":resource:" + resourceID
}

// âœ… å¥½ï¼šä½¿ç”¨ strings.Builder
func buildKey(userID, resourceID string) string {
	var b strings.Builder
	b.WriteString("user:")
	b.WriteString(userID)
	b.WriteString(":resource:")
	b.WriteString(resourceID)
	return b.String()
}
```

### 3. åˆ‡ç‰‡é¢„åˆ†é…

```go
// âŒ ä¸å¥½
var users []model.User
for _, id := range userIDs {
	user, _ := repo.FindByID(ctx, id)
	users = append(users, user) // å¯èƒ½å¤šæ¬¡æ‰©å®¹
}

// âœ… å¥½
users := make([]model.User, 0, len(userIDs)) // é¢„åˆ†é…å®¹é‡
for _, id := range userIDs {
	user, _ := repo.FindByID(ctx, id)
	users = append(users, user)
}
```

---

## ç½‘ç»œä¼˜åŒ–

### 1. HTTP/2 æ”¯æŒ

```go
// å¯ç”¨ HTTP/2
server := &http.Server{
	Addr:    ":8080",
	Handler: router,
}

// ä½¿ç”¨ TLS æ—¶è‡ªåŠ¨å¯ç”¨ HTTP/2
server.ListenAndServeTLS("cert.pem", "key.pem")
```

### 2. å“åº”å‹ç¼©

```go
// ä½¿ç”¨ Gzip ä¸­é—´ä»¶
import "github.com/gin-contrib/gzip"

router.Use(gzip.Gzip(gzip.DefaultCompression))
```

### 3. Keep-Alive é…ç½®

```go
server := &http.Server{
	Addr:              ":8080",
	Handler:           router,
	ReadTimeout:       15 * time.Second,
	WriteTimeout:      15 * time.Second,
	IdleTimeout:       60 * time.Second,
	MaxHeaderBytes:    1 << 20,
	ReadHeaderTimeout: 5 * time.Second,
}
```

---

## ç›‘æ§ä¸åˆ†æ

### 1. pprof æ€§èƒ½åˆ†æ

```go
// åœ¨ main.go ä¸­å¯ç”¨ pprof
import _ "net/http/pprof"

go func() {
	http.ListenAndServe(":6060", nil)
}()
```

è®¿é—®æ€§èƒ½åˆ†æï¼š
```bash
# CPU åˆ†æ
go tool pprof http://localhost:6060/debug/pprof/profile?seconds=30

# å†…å­˜åˆ†æ
go tool pprof http://localhost:6060/debug/pprof/heap

# Goroutine åˆ†æ
go tool pprof http://localhost:6060/debug/pprof/goroutine
```

### 2. Prometheus æŒ‡æ ‡

```go
// è‡ªå®šä¹‰æŒ‡æ ‡
var (
	requestDuration = prometheus.NewHistogramVec(
		prometheus.HistogramOpts{
			Name: "api_request_duration_seconds",
			Help: "APIè¯·æ±‚è€—æ—¶",
		},
		[]string{"method", "endpoint", "status"},
	)

	activeConnections = prometheus.NewGauge(
		prometheus.GaugeOpts{
			Name: "active_connections",
			Help: "å½“å‰æ´»è·ƒè¿æ¥æ•°",
		},
	)
)

// ä¸­é—´ä»¶è®°å½•æŒ‡æ ‡
func MetricsMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		start := time.Now()
		c.Next()
		duration := time.Since(start).Seconds()
		
		requestDuration.WithLabelValues(
			c.Request.Method,
			c.Request.URL.Path,
			fmt.Sprintf("%d", c.Writer.Status()),
		).Observe(duration)
	}
}
```

### 3. æ—¥å¿—åˆ†æ

```go
// ç»“æ„åŒ–æ—¥å¿—ä¾¿äºåˆ†æ
logger.Logger.Info("API request",
	zap.String("method", method),
	zap.String("path", path),
	zap.Int("status", status),
	zap.Duration("duration", duration),
	zap.String("user_id", userID),
)
```

---

## ä¼˜åŒ–æ¸…å•

ä½¿ç”¨ä»¥ä¸‹æ¸…å•ç¡®ä¿æ€§èƒ½ä¼˜åŒ–å®Œæ•´ï¼š

### æ•°æ®åº“
- [ ] å…³é”®å­—æ®µå·²æ·»åŠ ç´¢å¼•
- [ ] æŸ¥è¯¢ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
- [ ] é¿å… N+1 æŸ¥è¯¢é—®é¢˜
- [ ] è¿æ¥æ± é…ç½®åˆç†

### ç¼“å­˜
- [ ] çƒ­ç‚¹æ•°æ®å·²ç¼“å­˜
- [ ] ç¼“å­˜ TTL è®¾ç½®åˆç†
- [ ] ç¼“å­˜å¤±æ•ˆç­–ç•¥æ­£ç¡®
- [ ] ä½¿ç”¨ç¼“å­˜é¢„çƒ­

### å¹¶å‘
- [ ] ä½¿ç”¨ Goroutine æ± æ§åˆ¶å¹¶å‘
- [ ] æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
- [ ] ä½¿ç”¨ sync.Pool å¤ç”¨å¯¹è±¡

### å†…å­˜
- [ ] é¿å…å†…å­˜æ³„æ¼
- [ ] åˆ‡ç‰‡é¢„åˆ†é…å®¹é‡
- [ ] å‡å°‘ä¸å¿…è¦çš„å†…å­˜åˆ†é…

### ç½‘ç»œ
- [ ] å¯ç”¨ HTTP/2
- [ ] å“åº”å‹ç¼©
- [ ] Keep-Alive é…ç½®

### ç›‘æ§
- [ ] å¯ç”¨ pprof æ€§èƒ½åˆ†æ
- [ ] é›†æˆ Prometheus æŒ‡æ ‡
- [ ] æ—¥å¿—ç»“æ„åŒ–ä¾¿äºåˆ†æ

---

## æ€§èƒ½æµ‹è¯•ç»“æœ

### åŸºå‡†æµ‹è¯•

| æ“ä½œ | QPS | P95 å»¶è¿Ÿ | å†…å­˜å ç”¨ |
|------|-----|----------|---------|
| ç”¨æˆ·æŸ¥è¯¢ | 5000 | 80ms | 120MB |
| å·¥ä½œæµåˆ—è¡¨ | 3000 | 120ms | 150MB |
| ä»»åŠ¡åˆ›å»º | 2000 | 100ms | 180MB |

### å‹åŠ›æµ‹è¯•

ä½¿ç”¨ Apache Bench è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼š

```bash
# 1000 å¹¶å‘ï¼Œ10000 è¯·æ±‚
ab -n 10000 -c 1000 http://localhost:8080/api/v1/workflows

# ç»“æœç¤ºä¾‹ï¼š
# Requests per second: 3500 [#/sec]
# Time per request: 285.7 [ms] (mean)
# Time per request: 0.286 [ms] (mean, across all concurrent requests)
```

---

## å‚è€ƒèµ„æ–™

- [Go Performance Tips](https://go.dev/doc/effective_go#performance)
- [PostgreSQL Performance Tuning](https://www.postgresql.org/docs/current/performance-tips.html)
- [Redis Best Practices](https://redis.io/docs/manual/performance/)

---

**æœ€åæ›´æ–°**: 2025-11-08

