# å¿«é€Ÿå¼€å§‹æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å¿«é€Ÿæ­å»ºå’Œè¿è¡ŒåŠ©æ‰‹-è´¾ç»´æ–¯åç«¯æœåŠ¡çš„å¼€å‘ç¯å¢ƒã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

### å¿…éœ€
- **Go 1.21+** - [å®‰è£…æŒ‡å—](https://golang.org/doc/install)
- **Redis** - ç”¨äºç¼“å­˜
- **Supabase è´¦å·** - [æ³¨å†Œåœ°å€](https://supabase.com)

### å¯é€‰
- **Docker & Docker Compose** - ç”¨äºå®¹å™¨åŒ–éƒ¨ç½²
- **Air** - Go çƒ­é‡è½½å·¥å…·
- **golangci-lint** - ä»£ç æ£€æŸ¥å·¥å…·

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›®

```bash
cd backend
```

### 2. å®‰è£…ä¾èµ–

```bash
make install
```

æˆ–è€…

```bash
go mod download
go mod tidy
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶å¹¶å¡«å†™é…ç½®ï¼š

```bash
cp env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œå¡«å†™å¿…éœ€çš„é…ç½®é¡¹ï¼š

```env
# æœåŠ¡é…ç½®
ENV=development
PORT=8080

# Supabase é…ç½®ï¼ˆå¿…å¡«ï¼‰
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
SUPABASE_JWT_SECRET=your-jwt-secret

# Redis é…ç½®
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=

# æ—¥å¿—é…ç½®
LOG_LEVEL=debug

# å¯é€‰ï¼šé”™è¯¯è¿½è¸ª
SENTRY_DSN=
```

#### è·å– Supabase é…ç½®

1. ç™»å½• [Supabase Dashboard](https://app.supabase.com)
2. åˆ›å»ºæ–°é¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®
3. è¿›å…¥é¡¹ç›®è®¾ç½® (Settings) > API
4. å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **URL**: Project URL (ä¾‹å¦‚: `https://xxxxx.supabase.co`)
   - **Anon Key**: `anon` / `public` key
   - **JWT Secret**: åœ¨ Settings > API > JWT Settings

### 4. å¯åŠ¨ Redis

#### æ–¹å¼ 1: ä½¿ç”¨ Dockerï¼ˆæ¨èï¼‰

```bash
make redis-start
```

æˆ–è€…

```bash
docker run -d --name jarvis-redis -p 6379:6379 redis:7-alpine
```

#### æ–¹å¼ 2: æœ¬åœ°å®‰è£…

macOS:
```bash
brew install redis
brew services start redis
```

Linux:
```bash
sudo apt-get install redis-server
sudo systemctl start redis
```

### 5. è¿è¡ŒæœåŠ¡

#### æ–¹å¼ 1: ç›´æ¥è¿è¡Œ

```bash
make run
```

æˆ–è€…

```bash
go run ./cmd/server/main.go
```

#### æ–¹å¼ 2: å¼€å‘æ¨¡å¼ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰

é¦–å…ˆå®‰è£… Air:

```bash
go install github.com/cosmtrek/air@latest
```

ç„¶åè¿è¡Œ:

```bash
make dev
```

#### æ–¹å¼ 3: æ„å»ºåè¿è¡Œ

```bash
make build
./build/server
```

### 6. éªŒè¯æœåŠ¡

æœåŠ¡å¯åŠ¨åï¼Œè®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š

```bash
curl http://localhost:8080/health
```

é¢„æœŸå“åº”ï¼š

```json
{
  "status": "ok",
  "time": 1699449600
}
```

## ğŸ§ª æµ‹è¯• API

### æ³¨å†Œç”¨æˆ·

```bash
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "username": "testuser"
  }'
```

### ç”¨æˆ·ç™»å½•

```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'
```

### è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦è®¤è¯ï¼‰

```bash
TOKEN="your_access_token_here"

curl http://localhost:8080/api/v1/users/profile \
  -H "Authorization: Bearer $TOKEN"
```

## ğŸ³ ä½¿ç”¨ Docker

### æ„å»ºé•œåƒ

```bash
make docker-build
```

æˆ–è€…

```bash
docker build -t jarvis-backend:latest .
```

### ä½¿ç”¨ Docker Compose å¯åŠ¨

```bash
make docker-up
```

æˆ–è€…

```bash
docker-compose up -d
```

### æŸ¥çœ‹æ—¥å¿—

```bash
make docker-logs
```

æˆ–è€…

```bash
docker-compose logs -f
```

### åœæ­¢æœåŠ¡

```bash
make docker-down
```

æˆ–è€…

```bash
docker-compose down
```

## ğŸ“ å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ cmd/server/              # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ api/                # API å±‚
â”‚   â”‚   â”œâ”€â”€ handler/        # è¯·æ±‚å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ middleware/     # ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ websocket/      # WebSocket
â”‚   â”œâ”€â”€ service/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ repository/         # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ model/              # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ pkg/                # å·¥å…·åŒ…
â”‚   â””â”€â”€ config/             # é…ç½®ç®¡ç†
â”œâ”€â”€ migrations/             # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ docs/                   # æ–‡æ¡£
â””â”€â”€ build/                  # ç¼–è¯‘è¾“å‡º
```

### å¸¸ç”¨å‘½ä»¤

```bash
# å¼€å‘
make dev          # å¼€å‘æ¨¡å¼è¿è¡Œï¼ˆçƒ­é‡è½½ï¼‰
make run          # ç›´æ¥è¿è¡Œ
make build        # ç¼–è¯‘é¡¹ç›®

# æµ‹è¯•
make test         # è¿è¡Œæµ‹è¯•
make test-cover   # æµ‹è¯•è¦†ç›–ç‡

# ä»£ç è´¨é‡
make fmt          # æ ¼å¼åŒ–ä»£ç 
make vet          # é™æ€åˆ†æ
make lint         # ä»£ç æ£€æŸ¥

# å·¥å…·
make clean        # æ¸…ç†æ„å»ºæ–‡ä»¶
make help         # æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
```

### æ·»åŠ æ–°çš„ API ç«¯ç‚¹

1. **å®šä¹‰æ¨¡å‹** (`internal/model/`)
   ```go
   type CreateItemRequest struct {
       Name string `json:"name" binding:"required"`
   }
   ```

2. **åˆ›å»º Repository** (`internal/repository/`)
   ```go
   func (r *ItemRepo) Create(ctx context.Context, item *model.Item) error {
       // æ•°æ®åº“æ“ä½œ
   }
   ```

3. **å®ç° Service** (`internal/service/`)
   ```go
   func (s *ItemService) CreateItem(ctx context.Context, req *model.CreateItemRequest) (*model.Item, error) {
       // ä¸šåŠ¡é€»è¾‘
   }
   ```

4. **ç¼–å†™ Handler** (`internal/api/handler/`)
   ```go
   func (h *ItemHandler) Create(c *gin.Context) {
       var req model.CreateItemRequest
       if err := c.ShouldBindJSON(&req); err != nil {
           utils.Error(c, 40001, "å‚æ•°é”™è¯¯")
           return
       }
       // è°ƒç”¨ service
   }
   ```

5. **æ³¨å†Œè·¯ç”±** (`cmd/server/main.go`)
   ```go
   items := authenticated.Group("/items")
   {
       items.POST("", itemHandler.Create)
   }
   ```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Redis è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `Failed to init Redis cache`

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤ Redis å·²å¯åŠ¨: `redis-cli ping`
2. æ£€æŸ¥ `.env` ä¸­çš„ `REDIS_URL` é…ç½®
3. å¦‚æœä½¿ç”¨ Docker: `make redis-start`

### é—®é¢˜ 2: Supabase è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `Failed to init Supabase client`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `.env` ä¸­çš„ Supabase é…ç½®æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ Supabase é¡¹ç›®çŠ¶æ€æ­£å¸¸
3. éªŒè¯ API Key æœ‰æ•ˆæ€§

### é—®é¢˜ 3: ç«¯å£è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**: `bind: address already in use`

**è§£å†³æ–¹æ¡ˆ**:
1. ä¿®æ”¹ `.env` ä¸­çš„ `PORT` é…ç½®
2. æˆ–è€…å…³é—­å ç”¨ç«¯å£çš„è¿›ç¨‹:
   ```bash
   lsof -ti:8080 | xargs kill -9
   ```

### é—®é¢˜ 4: ä¾èµ–ä¸‹è½½å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# è®¾ç½® Go ä»£ç†ï¼ˆä¸­å›½å¤§é™†ç”¨æˆ·ï¼‰
export GOPROXY=https://goproxy.cn,direct

# æ¸…ç†å¹¶é‡æ–°ä¸‹è½½
go clean -modcache
go mod download
```

## ğŸ“š æ›´å¤šèµ„æº

- [æŠ€æœ¯æ¶æ„è®¾è®¡](./æŠ€æœ¯æ¶æ„è®¾è®¡.md)
- [é¡¹ç›®æ¦‚è§ˆ](./é¡¹ç›®æ¦‚è§ˆ.md)
- [API æ–‡æ¡£](./api-docs.md) (å¾…å®Œå–„)
- [Gin æ–‡æ¡£](https://gin-gonic.com/docs/)
- [Supabase æ–‡æ¡£](https://supabase.com/docs)
- [Go å®˜æ–¹æ–‡æ¡£](https://golang.org/doc/)

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
2. æ£€æŸ¥ [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥) éƒ¨åˆ†
3. æŸ¥é˜…ç›¸å…³æ–‡æ¡£
4. è”ç³»å›¢é˜Ÿæˆå‘˜

---

**ç¥å¼€å‘æ„‰å¿«ï¼** ğŸ‰

