# 用户注册登录功能修复完成

## 问题总结

用户注册失败，错误信息：`failed to create user profile: insert failed: (22P02) invalid input syntax for type uuid: ""`

## 根本原因

1. **Supabase RLS 策略阻止**：使用 anon key 无法插入和查询 user_profiles 表
2. **响应格式变化**：关闭邮箱确认后，Supabase Auth API 的响应格式发生了变化

## 解决方案

### 1. 关闭邮箱确认

在 Supabase Dashboard 中关闭了邮箱确认功能，这样注册时会立即返回 access_token。

### 2. 使用 access_token 绕过 RLS

修改了代码，在创建和查询 user_profiles 时使用用户的 access_token，而不是 anon key：

- `CreateProfileWithToken()` - 使用 token 创建 profile
- `FindByIDWithToken()` - 使用 token 查询 profile  
- `UpdateWithToken()` - 使用 token 更新 profile

### 3. 适配新的响应格式

更新了 Supabase Auth API 的响应解析：

**注册响应**（关闭邮箱确认后）：
```json
{
  "access_token": "...",
  "refresh_token": "...",
  "expires_in": 3600,
  "user": {
    "id": "...",
    "email": "..."
  }
}
```

**登录响应**：
```json
{
  "access_token": "...",
  "refresh_token": "...",
  "expires_in": 3600,
  "user": {
    "id": "...",
    "email": "..."
  }
}
```

## 测试结果

### 注册测试
```bash
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"newuser123","password":"password123","email":"newuser123@gmail.com"}'
```

✅ 成功返回：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "7a0d508f-fa62-4ace-95bc-0631ab78aaf0",
    "username": "newuser123",
    "membership_level": "free",
    "storage_quota_mb": 1000,
    "token_quota": 100000
  }
}
```

### 登录测试
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"newuser123@gmail.com","password":"password123"}'
```

✅ 成功返回：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "access_token": "eyJ...",
    "refresh_token": "...",
    "expires_in": 3600,
    "user": {
      "id": "7a0d508f-fa62-4ace-95bc-0631ab78aaf0",
      "username": "newuser123",
      "membership_level": "free"
    }
  }
}
```

## 修改的文件

1. `backend/internal/pkg/supabase/auth.go` - 更新响应格式解析
2. `backend/internal/repository/user_repo.go` - 添加带 token 的方法
3. `backend/internal/service/auth_service.go` - 使用 token 创建和查询 profile
4. `backend/.env` - 添加 service_role_key 配置项（备用）

## 注意事项

- 生产环境建议保持邮箱确认功能开启
- 如需邮箱确认，需要实现邮箱验证流程
- access_token 有效期为 1 小时，需要实现 refresh token 机制
