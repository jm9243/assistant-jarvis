# 架构文档

## 系统架构概览

Desktop Recorder Workflow 是一个基于 Electron 的跨平台桌面应用，采用前后端分离和模块化设计。

```
┌─────────────────────────────────────────────────────┐
│                   User Interface                     │
│              (React 18 + TypeScript)                 │
│  ┌──────────────┬──────────────┬──────────────────┐  │
│  │  Dashboard   │  Recorder    │  Editor          │  │
│  │  Templates   │  Task Center │  Elements        │  │
│  │  Settings    │  Agent       │  MCP Tools       │  │
│  └──────────────┴──────────────┴──────────────────┘  │
└──────────────────────────────────────────────────────┘
                         ↕ IPC
┌──────────────────────────────────────────────────────┐
│              Electron Main Process                   │
│  ┌──────────────────────────────────────────────┐   │
│  │         Application State & Storage          │   │
│  └──────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────┘
                         ↕ APIs
┌──────────────────────────────────────────────────────┐
│              Core Modules Layer                      │
│  ┌────────────────────────────────────────────────┐ │
│  │ Recorder │ Workflow │ Runtime │ Element │ MCP  │ │
│  │ Template │ Task     │ Agent   │ Security│      │ │
│  └────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘
                         ↕
┌──────────────────────────────────────────────────────┐
│            Platform APIs & External Services         │
│  ┌──────────────────────────────────────────────────┐ │
│  │ macOS AX APIs │ Windows UIA │ File System │ AI   │ │
│  └──────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 录制模块 (Recorder Module)

**责任**:
- 捕获用户操作事件
- 自动识别 UI 元素
- 生成可重放的步骤序列

**核心类**:
- `RecorderService`: 记录和管理录制会话
- `RecorderManager`: 管理多个录制会话

**工作流**:
```
启动录制 → 捕获事件 → 识别元素 → 生成选择器 → 
记录步骤 → 停止录制 → 返回会话
```

**关键接口**:
```typescript
interface RecordingSession {
  id: string;
  startTime: Date;
  endTime?: Date;
  isActive: boolean;
  steps: RecordedStep[];
}
```

### 2. 工作流模块 (Workflow Module)

**责任**:
- 编辑和构建工作流
- 管理工作流节点和边
- 执行工作流逻辑

**核心类**:
- `WorkflowBuilder`: 构建工作流 DAG
- `WorkflowEngine`: 执行工作流引擎

**支持的节点类型**:
- `action`: 执行操作（点击、输入等）
- `condition`: 条件分支
- `loop`: 循环结构
- `parallel`: 并行执行
- `wait`: 延迟等待
- `script`: 自定义脚本

**执行模型**:
```
DAG构建 → 拓扑排序 → 逐节点执行 → 处理分支 → 
维护执行上下文 → 错误处理 → 收集结果
```

### 3. 元素管理模块 (Element Module)

**责任**:
- 管理捕获的 UI 元素
- 生成和验证选择器
- 提供元素查询功能

**核心类**:
- `ElementManager`: 元素存储和查询
- `SelectorGenerator`: 选择器生成

**选择器策略**:
1. XPath - 最通用，但易于破裂
2. CSS Path - 快速定位
3. 角色属性 - 无障碍优先
4. 元素名称 - 易读
5. 图像识别 - 降级方案
6. OCR - 最后降级

**置信度计算**:
```
base_confidence = 0.5
+ 0.15 (有角色)
+ 0.15 (有名称)
+ 0.1 (有XPath)
+ 0.1 (有CSS路径)
+ 0.1 (唯一标识)
= 最高 1.0
```

### 4. 运行时和调试模块 (Runtime & Debugger)

**责任**:
- 管理工作流执行
- 提供调试功能
- 记录执行日志和截图

**核心类**:
- `RuntimeEngine`: 执行引擎
- `Debugger`: 调试和检查工具

**调试功能**:
- 断点设置和管理
- 单步执行
- 变量检查
- 执行快照
- 时间轴回放

**执行生命周期**:
```
初始化 → 运行前检查 → 执行工作流 → 
错误处理 → 收集结果 → 生成报告 → 完成
```

### 5. 智能体模块 (Agent Module)

**责任**:
- 集成 AI 模型决策
- 动态生成操作指令
- 实现自愈能力

**核心类**:
- `AgentNode`: 工作流中的 AI 节点

**决策流程**:
```
收集上下文 → 构建提示 → 调用AI模型 → 
验证决策 → 执行操作 → 记录结果 → 学习反馈
```

**上下文信息**:
- 当前屏幕截图
- 页面元素树
- 最近错误日志
- 执行历史

### 6. MCP 集成模块 (MCP Module)

**责任**:
- 暴露工作流为 MCP 工具
- 管理工具注册和调用
- 处理跨进程通信

**核心类**:
- `MCPServer`: MCP 服务器
- `ToolRegistry`: 工具注册表

**工作流**:
```
工作流注册 → 转换为MCP工具 → 定义Schema → 
接收调用 → 执行工作流 → 返回结果
```

### 7. 模板模块 (Template Module)

**责任**:
- 管理工作流模板
- 支持模板导入导出
- 提供模板库

**模板分类**:
- 网页自动化
- 文件处理
- 数据输入
- 系统操作
- 邮件处理
- 自定义

### 8. 任务管理模块 (Task Module)

**责任**:
- 管理任务生命周期
- 调度和触发任务
- 生成执行报告

**任务状态**:
```
pending → running → completed/failed
  ↑         ↑
  └─────────┘ (重试)
```

**调度类型**:
- Cron 表达式
- 时间间隔
- 事件触发

### 9. 安全模块 (Security Module)

**责任**:
- 权限管理
- 数据脱敏
- 审计日志
- 凭据加密

**权限**:
- 屏幕录制
- 无障碍 API
- 文件访问
- 剪贴板访问
- 摄像头访问
- 麦克风访问
- 网络访问

**敏感数据处理**:
```
检测敏感信息 → 应用脱敏规则 → 
记录审计日志 → 安全存储 → 定期清理
```

## 数据流

### 录制流程
```
用户操作 
  → 事件捕获 
  → 元素识别 
  → 选择器生成 
  → 步骤创建 
  → 会话存储
```

### 执行流程
```
工作流初始化 
  → 变量绑定 
  → 节点执行 
  → 条件判断 
  → 下一节点查询 
  → 错误处理 
  → 结果返回
```

### 调试流程
```
设置断点 
  → 执行到断点 
  → 暂停 
  → 检查变量 
  → 查看堆栈 
  → 继续/跳过 
  → 完成
```

## 通信模式

### IPC (Inter-Process Communication)

主进程 ↔ 渲染进程 通信:

```typescript
// 从渲染进程调用
await window.electron.ipcRenderer.invoke('channel', args);

// 主进程处理
ipcMain.handle('channel', async (event, args) => {
  // 处理逻辑
  return result;
});
```

### 事件驱动

各模块通过事件系统通信:

```typescript
// 发射事件
module.emit('eventName', data);

// 监听事件
module.on('eventName', (data) => {
  // 处理
});
```

## 状态管理

使用 Zustand 管理全局状态:

```typescript
const useAppStore = create((set) => ({
  workflows: [],
  addWorkflow: (workflow) => set(state => ({
    workflows: [...state.workflows, workflow]
  })),
  // ...
}));
```

## 扩展点

### 添加新的节点类型

1. 在 `WorkflowEngine` 中扩展 `executeNode`
2. 实现节点特定的执行逻辑
3. 更新类型定义

### 添加新的选择器策略

1. 在 `SelectorGenerator` 中添加生成方法
2. 注册策略和权重
3. 更新置信度计算

### 集成新的 AI 模型

1. 实现 `AgentNode` 子类
2. 在 `callAIModel` 中集成 API
3. 更新提示工程

### 添加新的权限

1. 在 `Permission` 枚举中添加
2. 实现权限检查逻辑
3. 添加权限对话框 UI

## 错误处理

### 分层错误处理

```
应用层 (UI)
  ↓
模块层 (try-catch)
  ↓
服务层 (validators)
  ↓
系统层 (platform APIs)
```

### 错误恢复

- **自动重试**: 可配置的重试次数和延迟
- **降级方案**: 使用备用选择器
- **人工干预**: 提示用户修复
- **日志记录**: 详细的错误信息用于调试

## 性能考虑

### 优化策略

1. **防抖和节流**: 减少事件频率
2. **虚拟化**: 大列表使用虚拟滚动
3. **代码分割**: 路由级别的代码分割
4. **懒加载**: 按需加载模块
5. **缓存**: 缓存选择器验证结果

### 监控指标

- 工作流执行时间
- 元素识别准确度
- 选择器失败率
- 内存使用量
- CPU 使用率

## 安全考虑

1. **沙箱隔离**: 渲染进程在沙箱中运行
2. **IPC 验证**: 验证所有 IPC 消息
3. **上下文隔离**: 启用 `contextIsolation`
4. **CSP**: 内容安全策略
5. **代码签名**: 发布时签名应用

## 跨平台适配

### macOS 特定

- 使用 AX (Accessibility) API
- 检测 Universal Binary 支持
- 处理 Retina 显示屏坐标缩放

### Windows 特定

- 使用 UIA (UI Automation) API
- 处理高 DPI 显示器
- 支持 Windows 原生主题

### 兼容性层

```typescript
if (process.platform === 'darwin') {
  // macOS 特定代码
} else if (process.platform === 'win32') {
  // Windows 特定代码
}
```

## 未来改进

1. **分布式执行**: 支持远程工作流执行
2. **协作编辑**: 多用户同时编辑工作流
3. **版本控制**: Git 风格的工作流版本管理
4. **性能分析**: 详细的性能指标和火焰图
5. **强化学习**: 通过使用学习优化选择器
6. **NLP**: 自然语言定义工作流
7. **视觉编程**: 类似 Scratch 的块编程
