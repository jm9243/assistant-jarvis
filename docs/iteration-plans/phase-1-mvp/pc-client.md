# Phase 1: 工作流系统 - PC端迭代计划

**阶段目标**: 建立完整的工作流自动化能力  
**预计时间**: 3个月  
**依赖**: 无（首个阶段）

---

## 目录

1. [功能清单](#功能清单)
2. [核心功能详解](#核心功能详解)
3. [技术架构](#技术架构)
4. [开发计划](#开发计划)
5. [验收标准](#验收标准)

---

## 功能清单

### 必须完成的功能模块

#### 1. 账号与安全 (对应PRD 4.1)
- [ ] 用户认证（账号密码登录、第三方登录）
- [ ] Token管理（JWT自动刷新、会话管理）
- [ ] 应用绑定（第三方应用集成、应用检测）
- [ ] 数据安全（本地加密存储、密钥管理）
- [ ] 权限系统（角色权限、功能权限、操作审计）

#### 2. 工作流设计中心 (对应PRD 4.2)
- [ ] 可视化画布（React Flow集成）
- [ ] 23种工作流节点完整实现
- [ ] 节点配置面板
- [ ] 元素定位策略（AXUI、OCR、Image、Position）
- [ ] 工作流属性配置
- [ ] 工作流管理（CRUD、导入导出、兼容性检查）

#### 3. 智能录制器 (对应PRD 4.3)
- [ ] 录制功能（启动、暂停、停止）
- [ ] 实时元素高亮（叠加窗口、Hover高亮）
- [ ] 智能选择器（稳定定位、自适应）
- [ ] 浏览器情境感知（Web录制模式）
- [ ] 录制模式（全自动、手动）

#### 4. 工作流执行与任务管理 (对应PRD 4.10)
- [ ] 工作流执行（手动执行、参数输入、实时日志）
- [ ] 执行状态管理（Pending、Running、Paused、Completed、Failed、Cancelled）
- [ ] 执行结果查看（节点结果、变量快照、截图记录）
- [ ] 任务队列管理
- [ ] 工作流触发器（通知触发）

#### 5. 系统监控与管理 (对应PRD 4.11)
- [ ] 系统信息展示
- [ ] 日志管理（记录、查看、上报）
- [ ] 通知管理（系统通知、通知中心）
- [ ] 文件下载管理
- [ ] 更新服务（自动更新）

#### 6. 系统软件扫描 (对应PRD 4.12)
- [ ] 跨平台应用扫描（macOS、Windows）
- [ ] 兼容性推荐

---

## 核心功能详解

### 1. 账号与安全

#### 1.1 用户认证
**功能描述**: 用户登录、注册、第三方登录

**核心子功能**:
- 账号密码登录（邮箱/用户名 + 密码）
- 第三方登录（微信扫码、Google账号）
- JWT Token自动刷新
- 多设备登录管理
- 异地登录提醒

**技术要点**:
- Tauri前端调用后端认证API
- Token存储在系统Keychain/Credential Manager
- 使用Supabase Auth提供的认证能力

**UI界面**:
- 登录页面
- 注册页面
- 第三方登录授权页面

---

#### 1.2 应用绑定
**功能描述**: 与第三方桌面应用集成，用于工作流自动化

**核心子功能**:
- 应用检测（macOS通过Bundle ID，Windows通过进程名）
- 应用列表展示
- API Token配置
- 连接有效性验证

**技术要点**:
- macOS: 使用`system_profiler`或读取`/Applications`目录
- Windows: 读取注册表`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall`
- Python Sidecar提供应用扫描能力

**UI界面**:
- 应用绑定设置页面
- 应用列表与状态展示

---

#### 1.3 数据安全
**功能描述**: 保护用户敏感数据

**核心子功能**:
- 本地敏感配置AES-256加密
- 系统密钥库存储（macOS Keychain、Windows Credential Manager）
- WebSocket/HTTPS加密传输
- 操作审计日志记录

**技术要点**:
- Tauri提供操作系统密钥库访问能力
- Python Sidecar使用`cryptography`库加密数据
- 所有云端通信使用HTTPS和WSS

---

### 2. 工作流设计中心

#### 2.1 可视化画布
**功能描述**: 基于React Flow的无限画布，支持拖拽编排工作流

**核心子功能**:
- 无限画布（拖拽、缩放、平移）
- 网格背景和对齐
- 小地图导航
- 画布操作（撤销/重做、复制/粘贴、批量选择）

**技术要点**:
- 使用React Flow库（或xyflow）
- 状态管理使用Zustand
- 节点连接支持条件分支、循环

**UI界面**:
- 工作流设计器主界面
- 节点库面板（左侧）
- 节点配置面板（右侧）
- 画布工具栏（顶部）

---

#### 2.2 23种工作流节点
**功能描述**: 完整实现PRD 4.2.2定义的23种节点类型

**节点分类**:

**UI自动化节点（7种）**:
1. **Click（点击）**
   - 配置: 单击/双击/右键、修饰键、偏移量、等待时间
   - 元素定位: 支持AXUI、OCR、Image、Position

2. **Input（输入）**
   - 配置: 输入文本、清空选项、输入速度、回车确认
   - 元素定位: 支持AXUI、OCR、Image、Position

3. **Drag & Drop（拖拽）**
   - 配置: 源元素、目标元素/位置、拖拽速度
   - 元素定位: 支持AXUI、OCR、Image、Position

4. **Scroll（滚动）**
   - 配置: 方向（上下左右）、滚动距离、滚动到指定元素
   - 元素定位: 支持AXUI、OCR、Image、Position

5. **Hover（悬停）**
   - 配置: 悬停时长、偏移量
   - 元素定位: 支持AXUI、OCR、Image、Position

6. **Keyboard（键盘）**
   - 配置: 按键、修饰键、组合键、按键间隔
   - 支持: 特殊键（Enter、Tab、Esc等）

7. **Delay（延迟）**
   - 配置: 延迟时长（秒、毫秒）

**流程控制节点（3种）**:
8. **Variable（变量操作）**
   - 配置: 变量名、操作类型（设置、获取、递增、追加、清除）、值

9. **Compare（比较）**
   - 配置: 左值、运算符（==、!=、>、<、>=、<=、contains、regex）、右值
   - 输出: True/False分支

10. **Data Extract（数据提取）**
    - 配置: 提取源（元素、页面、剪贴板）、提取方式（文本、正则、表格、列表）
    - 输出: 提取结果存储到变量

**集成节点（3种）**:
11. **HTTP Request（HTTP请求）**
    - 配置: 方法（GET、POST、PUT、DELETE）、URL、Headers、Body、Query参数
    - 输出: 响应状态码、响应体

12. **MCP Tool（MCP工具调用）**
    - 配置: 工具名称、参数映射
    - 输出: 工具执行结果
    - 注: Phase 1仅实现框架，Phase 2完善

13. **Subworkflow（子工作流）**
    - 配置: 工作流选择、参数映射
    - 输出: 子工作流执行结果

**文件操作节点（2种）**:
14. **File Selector（文件选择器）**
    - 配置: 选择类型（文件/文件夹）、单选/多选、文件类型过滤
    - 输出: 选中的文件路径

15. **File Operation（文件操作）**
    - 配置: 操作类型（读、写、复制、移动、删除）、文件路径、内容（写入时）
    - 输出: 操作结果

**系统操作节点（3种）**:
16. **Clipboard（剪贴板）**
    - 配置: 操作类型（读、写）、数据类型（文本、图片、HTML）
    - 输出: 剪贴板内容（读取时）

17. **Shell Command（Shell命令）**
    - 配置: 命令、工作目录、环境变量、超时时间
    - 输出: 标准输出、标准错误、退出码

18. **App Control（应用控制）**
    - 配置: 操作类型（启动、退出、激活、隐藏）、应用标识
    - 输出: 操作结果

**时间操作节点（1种）**:
19. **DateTime（日期时间）**
    - 配置: 操作类型（获取当前时间、格式化、计算）、格式、时区
    - 输出: 日期时间字符串或时间戳

**通知节点（1种）**:
20. **Notification（通知发送）**
    - 配置: 通知类型（系统通知、企业微信、钉钉、Slack）、标题、内容
    - 输出: 发送结果

**AI操作节点（2种）**:
21. **AI Process（AI处理）**
    - 配置: 操作类型（文本生成、分类、情感分析、提取、翻译、OCR）、模型、Prompt
    - 注: Phase 1仅实现框架，Phase 2完善

22. **AI Call（AI通话）**
    - 配置: 操作类型（启动/停止）、ASR配置、TTS配置、对话参数
    - 注: Phase 3实现

**Agent调用节点（1种）**:
23. **Agent Call（调用Agent）**
    - 配置: Agent选择、输入内容、会话管理、知识库绑定
    - 注: Phase 2实现

**Phase 1节点优先级**:
- **高优先级**（必须完成）: 节点1-10、14-20（共17个节点）
- **中优先级**（框架实现）: 节点11、21（HTTP Request、AI Process）
- **低优先级**（占位）: 节点12、13、22、23（后续阶段完善）

---

#### 2.3 节点配置面板
**功能描述**: 右侧面板，配置选中节点的详细参数

**核心子功能**:
- 基本属性（名称、描述、图标、颜色）
- 元素定位配置（定位策略、超时、重试）
- 操作参数配置（根据节点类型动态显示）
- 错误处理（失败时停止/继续/重试/跳转）
- 条件执行（基于变量的条件判断）
- 截图配置（执行前后截图）

**技术要点**:
- 使用React Form库（如react-hook-form）
- 动态表单根据节点类型渲染
- 实时保存配置到工作流JSON

---

#### 2.4 元素定位策略
**功能描述**: 支持多种元素定位方式，确保自动化的稳定性

**定位策略**:

**1. AXUI定位（优先级最高）**:
- **macOS**: 使用Accessibility API
  - Role（角色，如Button、TextField）
  - Title（标题）
  - Identifier（标识符）
  - AXPath（无障碍路径）
- **Windows**: 使用UI Automation
  - ControlType（控件类型，如Button、Edit）
  - Name（名称）
  - AutomationId（自动化ID）
  - Path（控件路径）

**2. OCR定位（备选）**:
- 使用Tesseract OCR识别屏幕文字
- 支持模糊匹配
- 支持正则表达式

**3. Image定位（备选）**:
- 基于图像模板匹配
- 使用OpenCV进行图像识别
- 支持相似度阈值配置

**4. Position定位（兜底）**:
- 基于屏幕坐标
- 支持相对位置（如"距离某元素右侧100px"）
- 不推荐使用，仅作兜底方案

**技术要点**:
- Python Sidecar使用pywinauto（Windows）或pyobjc（macOS）
- Tesseract OCR集成
- OpenCV图像识别
- 支持配置多个定位策略，按优先级依次尝试

---

#### 2.5 工作流管理
**功能描述**: 管理所有工作流的CRUD操作

**核心子功能**:
- 工作流列表（分类、标签、状态筛选）
- 搜索工作流（名称、描述）
- 新建、编辑、复制、删除工作流
- 导出/导入工作流（JSON格式）
- 发布/取消发布、归档
- 兼容性检查（操作系统、目标应用、权限）
- 快速适配（适配向导、元素重定位）

**技术要点**:
- 工作流定义使用JSON格式存储
- 本地存储使用SQLite或文件系统
- 云端同步通过Backend API

**UI界面**:
- 工作流列表页面
- 工作流详情页面

---

### 3. 智能录制器

#### 3.1 录制功能
**功能描述**: 一键录制用户操作，自动生成工作流

**核心子功能**:
- 一键启动（全局悬浮窗或快捷键）
- 暂停/恢复录制
- 停止录制并生成工作流
- 操作捕获（点击、输入、拖拽、滚动等）
- 元素捕获（记录操作的目标元素及定位信息）

**技术要点**:
- 使用pynput监听全局键鼠事件
- Python Sidecar捕获操作并记录
- 自动生成工作流节点

---

#### 3.2 实时元素高亮
**功能描述**: 录制时实时高亮鼠标下方的UI元素

**核心技术实现**:

**1. 叠加窗口（Overlay Window）创建**:
- Tauri创建全屏、透明、置顶、无边框窗口
- 窗口属性: `decorations: false`, `transparent: true`, `always_on_top: true`, `fullscreen: true`
- 设置`set_ignore_cursor_events(true)`使鼠标事件穿透

**2. 实时元素识别与高亮流程**:
```
用户移动鼠标
     ↓
Python引擎的pynput线程捕获鼠标坐标
     ↓
调用pywinauto/pyobjc获取指针下方的UI元素
     ↓
提取元素的屏幕矩形坐标（x, y, width, height）
     ↓
通过Tauri事件系统发送到前端叠加窗口
     ↓
叠加窗口中的JavaScript实时更新div元素的CSS样式
     ↓
在目标元素上"画"出高亮边框
```

**3. 元素状态**:
- **Hover高亮**: 鼠标悬停时黄色边框
- **Selected状态**: 选中元素时蓝色边框
- **Confirmed状态**: 确认元素时绿色边框

**4. 元素选择确认**:
- 用户点击鼠标或按Enter确认选择
- Python引擎记录元素选择器信息
- 生成稳定的元素定位器

**5. 性能优化**:
- 元素识别采用节流（throttle）机制
- 高亮边框更新使用requestAnimationFrame
- 缓存已识别的元素信息

**技术要点**:
- Tauri创建叠加窗口
- Python Sidecar捕获鼠标位置和元素信息
- Tauri事件系统实现前后端通信
- React渲染高亮边框

---

#### 3.3 智能选择器
**功能描述**: 生成稳定、可靠的元素选择器

**核心子功能**:
- 保存元素内在属性（文本、ID、角色）而非坐标
- 窗口大小、位置、分辨率变化时依然能准确找到元素
- 自动生成多个备选定位策略
- 按可靠性排序定位策略

**技术要点**:
- 优先使用AXUI属性（Role、Title、Identifier）
- 生成多个备选策略（如同时记录AXUI、OCR、Image）
- 定位时按优先级依次尝试

---

#### 3.4 浏览器情境感知
**功能描述**: 检测到浏览器操作时自动切换到Web录制模式

**核心子功能**:
- 检测浏览器应用（Chrome、Edge、Firefox、Safari）
- 自动启动Playwright连接到浏览器
- 使用持久化上下文（`launch_persistent_context`）保持登录状态
- 支持跨域名的Web自动化流程

**技术要点**:
- Python Sidecar集成Playwright
- 使用浏览器的用户数据目录保持登录状态
- Web元素使用CSS Selector或XPath定位

---

### 4. 工作流执行与任务管理

#### 4.1 工作流执行
**功能描述**: 执行工作流并展示实时进度

**核心子功能**:
- 手动执行（点击运行按钮）
- 参数输入（填写工作流参数）
- 参数记忆（记住上次输入）
- 参数模板（保存常用参数组合）
- 实时日志输出
- 进度显示（百分比、当前节点）
- 暂停/恢复执行
- 终止执行

**技术要点**:
- Tauri前端调用Python Sidecar执行工作流
- 使用WebSocket推送实时日志和进度
- 支持断点续传（暂停后恢复）

**UI界面**:
- 工作流执行页面
- 参数输入对话框
- 实时日志面板

---

#### 4.2 执行状态管理
**功能描述**: 管理工作流的执行状态

**状态类型**:
- **Pending**: 等待执行
- **Running**: 执行中
- **Paused**: 已暂停
- **Completed**: 执行成功
- **Failed**: 执行失败
- **Cancelled**: 已取消

**技术要点**:
- 状态存储在本地数据库
- 状态变化实时同步到云端
- 支持状态筛选和查询

---

#### 4.3 执行结果查看
**功能描述**: 查看工作流执行的详细结果

**核心子功能**:
- 节点结果（每个节点的执行结果）
- 变量快照（各作用域变量的最终值）
- 截图记录（节点执行前后的截图）
- 执行时长（总时长和每个节点时长）
- 错误信息（失败节点的错误详情）

**技术要点**:
- 执行结果存储在本地数据库
- 截图存储在本地文件系统
- 支持结果导出（JSON、HTML报告）

**UI界面**:
- 执行结果详情页面
- 节点执行时间线
- 截图查看器

---

#### 4.4 任务队列管理
**功能描述**: 管理所有待执行和执行中的任务

**核心子功能**:
- 任务列表（筛选、排序、搜索）
- 任务优先级（High、Medium、Low）
- 批量操作（执行、取消、删除）
- 立即执行（跳过队列）
- 重试任务
- 查看任务详情和日志

**技术要点**:
- 任务队列使用优先级队列
- 支持并发执行多个任务（可配置并发数）
- 任务状态实时同步

**UI界面**:
- 任务队列页面
- 任务详情抽屉

---

#### 4.5 工作流触发器
**功能描述**: 支持自动触发工作流执行

**Phase 1实现**:
- **通知触发**: 监听系统通知触发工作流
  - 通知来源筛选（企业微信、微信、系统）
  - 关键词匹配（OR关系）
  - 排除关键词
  - 发送人过滤
  - 优先级配置

**Phase 1暂不实现**:
- 定时触发（Phase 2）
- Webhook触发（Phase 2）

**技术要点**:
- Windows: 使用winrt-notifications监听通知
- macOS: 使用pyobjc访问NSUserNotificationCenter
- 匹配到触发条件时自动将任务加入队列

**UI界面**:
- 触发器配置页面

---

### 5. 系统监控与管理

#### 5.1 系统信息
**功能描述**: 展示系统基础信息和实时监控

**核心子功能**:
- 基础信息（操作系统、架构、Node版本、Electron版本、应用版本）
- 实时监控（CPU使用率、内存使用、磁盘使用、网络状态）

**技术要点**:
- Tauri调用系统API获取信息
- 使用psutil（Python）获取系统资源使用情况

**UI界面**:
- 系统信息页面
- 实时监控仪表盘

---

#### 5.2 日志管理
**功能描述**: 记录和查看应用日志

**核心子功能**:
- 日志记录（Debug、Info、Warn、Error级别）
- 日志分类（系统、任务、消息、错误）
- 日志查看（实时输出、筛选、搜索）
- 日志导出
- 日志上报到服务器

**技术要点**:
- 使用log4rs（Rust）或logging（Python）记录日志
- 日志文件轮转
- 错误日志立即上报

**UI界面**:
- 日志查看页面

---

#### 5.3 通知管理
**功能描述**: 管理系统通知

**核心子功能**:
- 系统通知（任务接收、失败、完成）
- 通知中心（通知列表、未读标记）
- 通知操作（跳转相关页面）
- 通知清理

**技术要点**:
- 使用Tauri的通知API
- 通知存储在本地数据库

**UI界面**:
- 通知中心页面

---

#### 5.4 文件下载管理
**功能描述**: 管理从服务器下载的文件

**核心子功能**:
- 下载功能（从服务器下载）
- 下载进度显示
- 断点续传
- 暂停/恢复/取消下载
- 打开文件/文件夹
- 下载历史

**技术要点**:
- Tauri提供文件下载能力
- 支持分片下载和断点续传

**UI界面**:
- 下载管理页面

---

#### 5.5 更新服务
**功能描述**: 自动检查和安装更新

**核心子功能**:
- 检查更新
- 更新提示
- 下载更新
- 安装更新并重启
- 更新配置（自动检查开关、更新通道）

**技术要点**:
- Tauri Updater功能
- 支持增量更新

**UI界面**:
- 更新提示对话框
- 更新设置页面

---

### 6. 系统软件扫描

#### 6.1 应用扫描
**功能描述**: 扫描系统已安装的应用程序

**核心子功能**:

**macOS扫描**:
- 扫描路径: `/Applications`、`~/Applications`、`/System/Applications`
- 解析`Info.plist`文件
- 使用`system_profiler`系统工具
- 提取信息: Bundle ID、名称、版本、路径、图标

**Windows扫描**:
- WMI查询: `Win32_Product`
- 注册表扫描: `HKLM/HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall`
- 开始菜单扫描
- 提取信息: 显示名称、发布者、版本、路径、可执行文件名

**通用能力**:
- 进程名猜测
- 版本解析（semver）
- 应用信息缓存

**技术要点**:
- Python Sidecar实现应用扫描
- 扫描结果缓存到本地数据库
- 定期更新扫描结果

---

#### 6.2 兼容性推荐
**功能描述**: 推荐兼容的工作流

**核心子功能**:
- 自动匹配工作流的目标应用
- 推荐兼容的工作流
- 版本匹配检查（semver范围）
- 跨平台提示

**技术要点**:
- 工作流定义中包含目标应用和版本要求
- 扫描结果与工作流要求匹配

**UI界面**:
- 工作流列表中显示兼容性标记
- 兼容性检查详情页面

---

## 技术架构

### 前端架构（Tauri 2 + React）

```
┌─────────────────────────────────────────────────────────┐
│                      Tauri 2 应用                        │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              React 应用 (TypeScript)                │ │
│  │                                                     │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │ │
│  │  │ 工作流设计器 │  │  智能录制器  │  │ 任务管理 │ │ │
│  │  │ (React Flow) │  │ (叠加窗口)   │  │          │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────┘ │ │
│  │                                                     │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │ │
│  │  │ 系统设置     │  │  日志查看    │  │ 通知中心 │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────┘ │ │
│  │                                                     │ │
│  │  状态管理: Zustand                                  │ │
│  │  UI组件: Tailwind CSS + Shadcn UI                  │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              Tauri Rust 核心                        │ │
│  │                                                     │ │
│  │  - 管理Python Sidecar生命周期                       │ │
│  │  - 提供IPC通信接口                                  │ │
│  │  - 系统API调用（文件、通知、更新等）                │ │
│  │  - 叠加窗口管理                                     │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                         ↕ IPC / HTTP
┌─────────────────────────────────────────────────────────┐
│              Python Sidecar 引擎                         │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              工作流执行引擎                          │ │
│  │                                                     │ │
│  │  - 节点执行器（23种节点）                           │ │
│  │  - 变量作用域管理                                   │ │
│  │  - 错误处理与重试                                   │ │
│  │  - 执行状态管理                                     │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              GUI自动化工具                           │ │
│  │                                                     │ │
│  │  - pywinauto (Windows)                              │ │
│  │  - pyobjc (macOS)                                   │ │
│  │  - pynput (键鼠监听)                                │ │
│  │  - Playwright (Web自动化)                           │ │
│  │  - Tesseract (OCR)                                  │ │
│  │  - OpenCV (图像识别)                                │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              系统集成工具                            │ │
│  │                                                     │ │
│  │  - 通知监听 (winrt-notifications / pyobjc)         │ │
│  │  - 应用扫描                                         │ │
│  │  - 系统信息采集                                     │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  打包: PyInstaller                                       │
└─────────────────────────────────────────────────────────┘
```

---

### 核心技术栈

**前端**:
- 框架: Tauri 2
- UI库: React 18 + TypeScript
- 状态管理: Zustand
- 工作流引擎: React Flow (或xyflow)
- 样式: Tailwind CSS
- UI组件: Shadcn UI
- 图标: Lucide React

**后端引擎（Python Sidecar）**:
- 框架: FastAPI（提供HTTP API）
- GUI自动化:
  - Windows: pywinauto
  - macOS: pyobjc
- 键鼠监听: pynput
- Web自动化: Playwright
- OCR: pytesseract + Tesseract
- 图像识别: opencv-python
- 通知监听:
  - Windows: winrt-notifications
  - macOS: pyobjc (NSUserNotificationCenter)
- 打包: PyInstaller

**数据存储**:
- 本地数据库: SQLite（存储工作流、任务、日志等）
- 配置文件: JSON
- 敏感数据: 系统Keychain/Credential Manager

---

### 数据模型

#### 1. 用户 (User)
```json
{
  "id": "uuid",
  "username": "string",
  "email": "string",
  "avatar": "string",
  "created_at": "datetime",
  "last_login": "datetime"
}
```

#### 2. 工作流 (Workflow)
```json
{
  "id": "uuid",
  "name": "string",
  "description": "string",
  "category": "string",
  "tags": ["string"],
  "icon": "string",
  "version": "string",
  "os_requirements": ["macOS", "Windows"],
  "target_apps": [
    {
      "name": "string",
      "bundle_id": "string",
      "version_range": "string"
    }
  ],
  "parameters": [
    {
      "name": "string",
      "type": "string|number|boolean|file",
      "description": "string",
      "required": true,
      "default": "any"
    }
  ],
  "nodes": [
    {
      "id": "string",
      "type": "string",
      "position": {"x": 0, "y": 0},
      "data": {
        "label": "string",
        "config": {}
      }
    }
  ],
  "edges": [
    {
      "id": "string",
      "source": "string",
      "target": "string",
      "type": "default|conditional"
    }
  ],
  "triggers": [
    {
      "type": "notification",
      "config": {}
    }
  ],
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

#### 3. 任务 (Task)
```json
{
  "id": "uuid",
  "workflow_id": "uuid",
  "status": "pending|running|paused|completed|failed|cancelled",
  "priority": "high|medium|low",
  "parameters": {},
  "start_time": "datetime",
  "end_time": "datetime",
  "duration": "number",
  "result": {
    "success": true,
    "nodes": [
      {
        "node_id": "string",
        "status": "success|failed|skipped",
        "duration": "number",
        "output": "any",
        "error": "string",
        "screenshots": ["string"]
      }
    ],
    "variables": {}
  },
  "created_at": "datetime"
}
```

#### 4. 日志 (Log)
```json
{
  "id": "uuid",
  "level": "debug|info|warn|error",
  "category": "system|task|message|error",
  "message": "string",
  "details": {},
  "task_id": "uuid",
  "created_at": "datetime"
}
```

---

## 开发计划

### 时间线（共3个月）

#### 第1个月：基础架构与核心能力

**Week 1-2: 项目初始化与基础架构**
- [ ] 项目脚手架搭建（Tauri 2 + React）
- [ ] Python Sidecar框架搭建（FastAPI）
- [ ] Tauri与Python通信机制实现（IPC/HTTP）
- [ ] 本地数据库设计与初始化（SQLite）
- [ ] 基础UI框架搭建（Tailwind + Shadcn UI）
- [ ] 用户认证UI与逻辑实现
- [ ] 后端认证API对接（Supabase Auth）

**Week 3-4: 工作流设计器基础**
- [ ] React Flow集成与自定义
- [ ] 无限画布实现（拖拽、缩放、平移）
- [ ] 节点库UI实现（左侧面板）
- [ ] 节点配置面板UI实现（右侧面板）
- [ ] 实现前7个UI自动化节点（Click、Input、Drag、Scroll、Hover、Keyboard、Delay）
- [ ] 工作流保存与加载

---

#### 第2个月：智能录制器与节点完善

**Week 5-6: 智能录制器核心**
- [ ] 叠加窗口实现（Tauri透明窗口+鼠标穿透）
- [ ] Python Sidecar实现元素识别（pywinauto/pyobjc）
- [ ] pynput键鼠监听集成
- [ ] 实时元素高亮功能
- [ ] 元素选择与确认逻辑
- [ ] 录制功能（启动、暂停、停止）
- [ ] 自动生成工作流节点

**Week 7-8: 节点完善与执行引擎**
- [ ] 实现流程控制节点（Variable、Compare、Data Extract）
- [ ] 实现集成节点（HTTP Request、Subworkflow，MCP Tool占位）
- [ ] 实现文件操作节点（File Selector、File Operation）
- [ ] 实现系统操作节点（Clipboard、Shell Command、App Control）
- [ ] 实现时间操作节点（DateTime）
- [ ] 实现通知节点（Notification）
- [ ] AI节点占位（AI Process、AI Call、Agent Call）
- [ ] 工作流执行引擎核心逻辑
- [ ] 变量作用域管理
- [ ] 错误处理与重试机制

---

#### 第3个月：任务管理与系统完善

**Week 9-10: 任务管理与执行**
- [ ] 任务队列实现（优先级队列）
- [ ] 任务执行UI（实时日志、进度显示）
- [ ] 暂停/恢复/终止执行
- [ ] 执行结果详情页面
- [ ] 节点执行截图功能
- [ ] 通知触发器实现（监听系统通知）
- [ ] 工作流管理页面（列表、筛选、搜索）
- [ ] 工作流导入/导出

**Week 11-12: 系统功能与优化**
- [ ] 系统信息展示页面
- [ ] 日志管理功能
- [ ] 通知中心
- [ ] 文件下载管理
- [ ] 更新服务集成
- [ ] 系统软件扫描（macOS + Windows）
- [ ] 兼容性推荐
- [ ] 元素定位策略完善（AXUI、OCR、Image、Position）
- [ ] Playwright集成（Web自动化、持久化上下文）
- [ ] 性能优化
- [ ] Bug修复与测试

---

### 开发任务分配建议

**前端团队（2人）**:
- 工程师A: 工作流设计器、节点库、节点配置面板
- 工程师B: 智能录制器UI、任务管理、系统设置页面

**Python后端团队（2人）**:
- 工程师C: 工作流执行引擎、节点执行器、元素定位策略
- 工程师D: 智能录制器后端、GUI自动化、通知监听

**UI/UX设计师（1人）**:
- 负责所有界面设计、交互设计、图标设计

**测试工程师（1人）**:
- 功能测试、兼容性测试（Windows + macOS）、自动化测试

---

### 开发里程碑

**Milestone 1（第1个月末）**: 基础架构完成
- ✅ 用户认证可用
- ✅ 工作流设计器基础功能可用
- ✅ 前7个UI自动化节点可用
- ✅ 工作流可以保存和加载

**Milestone 2（第2个月末）**: 核心功能完成
- ✅ 智能录制器可用
- ✅ 23种节点全部实现
- ✅ 工作流执行引擎可用
- ✅ 简单工作流可以录制和执行

**Milestone 3（第3个月末）**: Phase 1完成
- ✅ 任务管理完整可用
- ✅ 系统功能全部完成
- ✅ 性能和稳定性达标
- ✅ 通过验收标准

---

## 验收标准

### 功能性验收

#### 1. 用户认证
- [ ] 用户可以注册、登录、退出
- [ ] 支持邮箱和第三方登录
- [ ] Token自动刷新正常工作
- [ ] 多设备登录管理正常

#### 2. 工作流设计
- [ ] 用户可以创建新工作流
- [ ] 可以拖拽添加节点到画布
- [ ] 可以连接节点形成流程
- [ ] 可以配置每个节点的参数
- [ ] 可以保存和加载工作流
- [ ] 可以导入/导出工作流（JSON）
- [ ] 支持撤销/重做操作

#### 3. 智能录制
- [ ] 用户可以启动录制模式
- [ ] 鼠标移动时实时高亮UI元素
- [ ] 可以选择和确认元素
- [ ] 点击、输入、拖拽等操作可以被正确捕获
- [ ] 录制结束后自动生成工作流
- [ ] 生成的工作流可以正常执行

#### 4. 工作流执行
- [ ] 工作流可以手动执行
- [ ] 执行过程中显示实时日志
- [ ] 可以暂停/恢复/终止执行
- [ ] 执行完成后显示详细结果
- [ ] 节点执行截图正常保存
- [ ] 变量在节点间正确传递

#### 5. 元素定位
- [ ] AXUI定位在Windows和macOS上正常工作
- [ ] OCR定位可以识别文字并点击
- [ ] Image定位可以识别图片并点击
- [ ] Position定位可以按坐标点击
- [ ] 支持配置多个定位策略并按优先级尝试

#### 6. 节点功能
- [ ] 所有17个高优先级节点功能正常
- [ ] Click节点支持单击/双击/右键
- [ ] Input节点支持清空和输入
- [ ] Drag节点支持拖拽到元素或位置
- [ ] Variable节点支持变量操作
- [ ] Compare节点支持条件分支
- [ ] Data Extract节点支持数据提取
- [ ] HTTP Request节点支持GET/POST请求
- [ ] File Operation节点支持文件操作
- [ ] Shell Command节点支持执行系统命令
- [ ] Notification节点支持发送通知

#### 7. 任务管理
- [ ] 任务可以加入队列
- [ ] 任务按优先级执行
- [ ] 可以查看任务列表和状态
- [ ] 可以取消等待中的任务
- [ ] 可以重试失败的任务
- [ ] 任务历史可以查询

#### 8. 触发器
- [ ] 通知触发器可以正常工作
- [ ] 可以配置触发条件（关键词、来源等）
- [ ] 匹配到触发条件时自动执行工作流

#### 9. 系统功能
- [ ] 系统信息正确显示
- [ ] 日志可以查看和筛选
- [ ] 通知中心显示系统通知
- [ ] 应用扫描可以发现已安装应用
- [ ] 自动更新功能正常

---

### 性能验收

#### 1. 启动性能
- [ ] 应用冷启动时间 < 3秒
- [ ] 热启动时间 < 1秒

#### 2. 运行性能
- [ ] 空闲状态内存占用 < 200MB
- [ ] 执行工作流时内存占用 < 500MB
- [ ] 空闲状态CPU占用 < 5%
- [ ] UI操作响应时间 < 100ms

#### 3. 工作流执行性能
- [ ] 简单工作流（<10个节点）执行时间 < 5秒
- [ ] 元素定位成功率 > 90%
- [ ] 元素定位超时时间可配置（默认5秒）
- [ ] 工作流执行成功率 > 90%

#### 4. 录制性能
- [ ] 元素识别延迟 < 100ms
- [ ] 高亮边框渲染流畅（>30fps）
- [ ] 录制过程不影响正常操作

---

### 兼容性验收

#### 1. 操作系统
- [ ] Windows 10/11 正常运行
- [ ] macOS 11.0+ 正常运行
- [ ] 支持不同分辨率（1280x720 至 4K）

#### 2. 浏览器自动化
- [ ] 支持Chrome浏览器自动化
- [ ] 支持Edge浏览器自动化
- [ ] 支持Firefox浏览器自动化（可选）
- [ ] 支持Safari浏览器自动化（macOS，可选）
- [ ] 持久化上下文保持登录状态

#### 3. 应用集成
- [ ] 可以自动化常见应用（如记事本、计算器）
- [ ] 可以检测和列出已安装应用
- [ ] 应用绑定功能正常

---

### 稳定性验收

#### 1. 错误处理
- [ ] 节点执行失败时不会导致应用崩溃
- [ ] 网络错误时有友好提示
- [ ] 元素定位失败时有重试机制
- [ ] 关键错误会记录日志并上报

#### 2. 数据安全
- [ ] 敏感配置加密存储
- [ ] Token存储在系统密钥库
- [ ] 日志中敏感信息脱敏
- [ ] 操作审计日志完整

#### 3. 状态一致性
- [ ] 工作流保存后可以正确加载
- [ ] 任务状态在重启后保持一致
- [ ] 未完成的任务可以恢复

---

### 用户体验验收

#### 1. 界面设计
- [ ] 界面美观、现代
- [ ] 交互流畅、响应快
- [ ] 图标清晰、易懂
- [ ] 布局合理、易用

#### 2. 操作引导
- [ ] 新用户有引导教程
- [ ] 关键功能有提示说明
- [ ] 错误信息清晰易懂
- [ ] 提供帮助文档入口

#### 3. 易用性
- [ ] 录制功能易于理解和使用
- [ ] 工作流设计直观
- [ ] 节点配置简单明了
- [ ] 任务管理清晰可见

---

## 风险与应对

### 技术风险

#### 风险1: Tauri Sidecar模式不稳定
**影响**: 前后端通信可能出现问题，影响核心功能
**应对措施**:
- Week 1-2提前进行POC验证
- 准备备选方案（本地HTTP服务）
- 建立完善的错误处理和重连机制

#### 风险2: 跨平台GUI自动化兼容性问题
**影响**: 同一工作流在不同平台上表现不一致
**应对措施**:
- 尽早在Windows和macOS双平台测试
- 建立平台差异文档
- 提供平台特定的节点实现

#### 风险3: 元素定位不稳定
**影响**: 工作流执行失败率高
**应对措施**:
- 实现多种定位策略降级机制
- 提供手动调试工具
- 收集失败案例不断优化

#### 风险4: 虚拟音频设备驱动安装失败
**影响**: AI通话功能无法使用（Phase 3影响）
**应对措施**:
- Phase 1不涉及，Phase 3时提前验证
- 提供详细的安装指南
- 准备技术支持方案

---

### 进度风险

#### 风险1: 智能录制器开发超时
**影响**: 第2个月进度延迟
**应对措施**:
- 叠加窗口和元素高亮是难点，预留更多时间
- 分阶段实现：先基础高亮，再完善交互
- 必要时降低动画流畅度要求

#### 风险2: 节点开发量大
**影响**: 第2-3个月进度紧张
**应对措施**:
- 优先实现高优先级节点（17个）
- 低优先级节点（AI相关）仅实现占位
- 并行开发，前后端同步推进

#### 风险3: 测试时间不足
**影响**: 产品质量不达标
**应对措施**:
- 从Week 1开始就进行持续测试
- 每周至少1次集成测试
- 第3个月预留2周时间专门测试和修复

---

### 资源风险

#### 风险1: 关键技术人员不足
**影响**: 开发进度延迟
**应对措施**:
- 提前招聘和培训
- 建立完善的技术文档
- 代码review确保质量

#### 风险2: 设计资源不足
**影响**: UI界面完成度低
**应对措施**:
- 使用Shadcn UI等现成组件库
- 优先设计核心功能界面
- 细节优化可放到Phase 2

---

## 交付物清单

### 代码交付物
- [ ] PC端应用源代码（Tauri 2 + React）
- [ ] Python Sidecar引擎源代码
- [ ] 构建脚本和打包配置
- [ ] 单元测试代码
- [ ] 集成测试脚本

### 文档交付物
- [ ] 技术架构文档
- [ ] API接口文档
- [ ] 数据库设计文档
- [ ] 部署文档
- [ ] 用户使用手册
- [ ] 开发者文档

### 应用交付物
- [ ] Windows安装包（.msi或.exe）
- [ ] macOS安装包（.dmg）
- [ ] 应用图标和资源文件

### 测试交付物
- [ ] 测试用例文档
- [ ] 测试报告
- [ ] Bug列表和修复记录
- [ ] 性能测试报告

---

## 后续计划

Phase 1完成后，进入Phase 2: 三种Agent开发。

**Phase 2的依赖**:
- ✅ 工作流系统可以被Agent调用
- ✅ 节点执行器支持扩展（Agent Call节点）
- ✅ 用户认证系统完善
- ✅ 知识库基础架构

**Phase 1需要预留的扩展点**:
- [ ] Agent Call节点占位
- [ ] AI Process节点占位
- [ ] MCP Tool节点基础框架
- [ ] 工具调用接口设计

---

## 附录

### 附录A: 关键技术文档链接

**Tauri**:
- 官方文档: https://tauri.app/
- Sidecar指南: https://tauri.app/v1/guides/building/sidecar

**React Flow**:
- 官方文档: https://reactflow.dev/
- 示例: https://reactflow.dev/examples

**Python自动化库**:
- pywinauto: https://pywinauto.readthedocs.io/
- pyobjc: https://pyobjc.readthedocs.io/
- Playwright: https://playwright.dev/python/
- pynput: https://pynput.readthedocs.io/

**Supabase**:
- 官方文档: https://supabase.com/docs
- Auth指南: https://supabase.com/docs/guides/auth

---

### 附录B: 常见问题

**Q1: 为什么使用Tauri而不是Electron？**
A: Tauri体积更小、性能更好、资源占用更少，更适合桌面应用。

**Q2: 为什么Python Sidecar而不是直接用JavaScript？**
A: Python在GUI自动化、AI集成方面有更丰富的生态，pywinauto/pyobjc是成熟的GUI自动化库。

**Q3: 工作流定义为什么使用JSON而不是YAML？**
A: JSON是JavaScript原生支持的格式，方便前端处理，且更适合结构化存储。

**Q4: 为什么要实现多种元素定位策略？**
A: 单一定位策略不够稳定，多策略降级可以提高自动化成功率。

**Q5: Phase 1是否支持定时触发？**
A: 暂不支持，定时触发放在Phase 2实现。Phase 1仅支持通知触发。

---

### 附录C: 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| V1.0 | 2025-11-08 | 初始版本 | 产品团队 |

---

**文档状态**: ✅ 完成  
**最后更新**: 2025-11-08

**下一步**: 查看 [Phase 1: 工作流系统 - 后台服务迭代计划](./backend-service.md)