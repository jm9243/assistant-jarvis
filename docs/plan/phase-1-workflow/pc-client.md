# Phase 1: 工作流系统 - PC端开发计划

**阶段目标**: 建立完整的工作流自动化能力  
**预计时间**: 3个月  
**依赖**: 无（首个阶段）

---

## 目录

1. [功能清单](#功能清单)
2. [核心功能详解](#核心功能详解)
3. [开发计划](#开发计划)
4. [验收标准](#验收标准)

---

## 功能清单

### 必须完成的功能模块

#### 1. 账号与安全
- [ ] 用户认证（账号密码登录、第三方登录）
- [ ] Token管理（JWT自动刷新、会话管理）
- [ ] 应用绑定（第三方应用集成、应用检测）
- [ ] 数据安全（本地加密存储、密钥管理）

#### 2. 工作流设计中心
- [ ] 可视化画布（React Flow集成）
- [ ] 17种核心节点实现（UI自动化7个 + 流程控制3个 + 其他7个）
- [ ] 节点配置面板
- [ ] 元素定位策略（AXUI、OCR、Image、Position）
- [ ] 工作流管理（CRUD、导入导出）

#### 3. 智能录制器
- [ ] 录制功能（启动、暂停、停止）
- [ ] 实时元素高亮（叠加窗口）
- [ ] 智能选择器（稳定定位）
- [ ] 浏览器情境感知（Web录制）

#### 4. 工作流执行与任务管理
- [ ] 工作流执行（手动执行、实时日志）
- [ ] 执行状态管理
- [ ] 任务队列管理
- [ ] 通知触发器

#### 5. 系统监控与管理
- [ ] 系统信息展示
- [ ] 日志管理
- [ ] 通知管理
- [ ] 更新服务

#### 6. 系统软件扫描
- [ ] 跨平台应用扫描（macOS、Windows）
- [ ] 兼容性推荐

---

## 核心功能详解

### 1. 用户认证

#### 登录页面
**功能**: 用户登录、注册、第三方登录

**UI布局**（分屏式设计）:
```
┌─────────────────────────────────────────────┐
│  ┌──────────────┐  ┌──────────────────────┐ │
│  │              │  │   欢迎回来，指挥官    │ │
│  │  贾维斯3D    │  │                      │ │
│  │  动画展示    │  │   📧 邮箱或用户名     │ │
│  │              │  │   🔒 密码            │ │
│  │  Slogan      │  │   ☑️ 记住我          │ │
│  │              │  │                      │ │
│  │              │  │   [登 录 →]         │ │
│  │              │  │                      │ │
│  │              │  │   ─── 或者 ───      │ │
│  │              │  │   🔵微信 🌐Google   │ │
│  └──────────────┘  └──────────────────────┘ │
└─────────────────────────────────────────────┘
```

**技术要点**:
- 左侧: Three.js渲染贾维斯3D模型
- 右侧: 登录表单，调用Supabase Auth
- Token存储在系统Keychain

---

### 2. 工作流设计中心

#### 2.1 主界面布局

```
┌────────────── 顶部工具栏 (56px) ──────────────┐
│  ← 返回 | 工作流名称 | 版本 | [保存] [发布]   │
└───────────────────────────────────────────────┘
┌── 左侧节点库 280px ──┬─ 画布 ─┬── 右侧配置 320px ──┐
│ 🔍 搜索节点          │        │ 节点配置面板        │
│                     │        │                    │
│ ▼ UI自动化 (7)      │ React  │ • 基础信息          │
│   Click             │ Flow   │ • 元素定位          │
│   Input             │ 画布   │ • 操作参数          │
│   Drag & Drop       │        │ • 错误处理          │
│   ...               │        │                    │
│                     │        │                    │
│ ▼ 流程控制 (3)      │        │                    │
│   Variable          │        │                    │
│   Compare           │        │                    │
│   Data Extract      │        │                    │
│                     │        │                    │
│ ▼ 集成 (2)          │        │                    │
│   HTTP Request      │        │                    │
│   Subworkflow       │        │                    │
└─────────────────────┴────────┴────────────────────┘
```

**核心节点（Phase 1必须完成17个）**:

**UI自动化节点（7个）**:
1. Click - 点击元素
2. Input - 输入文本
3. Drag & Drop - 拖拽元素
4. Scroll - 滚动页面
5. Hover - 鼠标悬停
6. Keyboard - 键盘按键
7. Delay - 延迟等待

**流程控制节点（3个）**:
8. Variable - 变量操作
9. Compare - 条件比较
10. Data Extract - 数据提取

**集成节点（2个）**:
11. HTTP Request - HTTP请求
12. Subworkflow - 子工作流

**文件操作节点（2个）**:
13. File Selector - 文件选择
14. File Operation - 文件操作

**系统操作节点（3个）**:
15. Clipboard - 剪贴板
16. Shell Command - Shell命令
17. App Control - 应用控制

**其他节点（占位，Phase 2完善）**:
- DateTime - 日期时间
- Notification - 通知发送
- AI Process - AI处理（占位）
- AI Call - AI通话（Phase 3）
- Agent Call - Agent调用（Phase 2）
- MCP Tool - MCP工具（Phase 2）

---

#### 2.2 元素定位策略

**定位优先级**:
1. **AXUI定位**（最优先）
   - macOS: Role、Title、Identifier、AXPath
   - Windows: ControlType、Name、AutomationId、Path

2. **OCR定位**（备选）
   - Tesseract OCR识别文字
   - 支持模糊匹配和正则

3. **Image定位**（备选）
   - OpenCV图像模板匹配
   - 支持相似度阈值

4. **Position定位**（兜底）
   - 基于屏幕坐标
   - 不推荐，仅作兜底

**配置界面**:
```
┌─ 元素定位配置 ─────────────────────────┐
│ 定位策略:                              │
│ ☑️ AXUI定位 (优先级: 1)                │
│   Role: Button                        │
│   Title: 登录                         │
│   Identifier: login-btn               │
│                                       │
│ ☑️ OCR定位 (优先级: 2)                 │
│   文本: 登录                          │
│   模糊匹配: ☑️                        │
│                                       │
│ ☐ Image定位 (优先级: 3)               │
│   [上传模板图片]                       │
│                                       │
│ 超时时间: 5秒                          │
│ 重试次数: 3次                          │
└───────────────────────────────────────┘
```

---

### 3. 智能录制器

#### 3.1 录制流程

```
用户点击"录制"
     ↓
创建透明叠加窗口（全屏、置顶、鼠标穿透）
     ↓
Python Sidecar启动元素监听
     ↓
用户移动鼠标 → 实时高亮元素（黄色边框）
     ↓
用户点击/操作 → 捕获操作并记录
     ↓
用户点击"停止" → 生成工作流
```

#### 3.2 叠加窗口设计

**实时元素高亮**:
```
┌─────────────────────────────────────────┐
│                                         │
│     ┌─────────────────┐                │
│     │  [登录按钮]     │ ← 黄色高亮边框  │
│     └─────────────────┘                │
│     Button | login-btn                 │ ← 元素信息提示
│                                         │
│                                         │
│  [⏺ 录制中] [⏸ 暂停] [⏹ 停止]         │ ← 控制栏
│  已录制: 5步 | 00:02:35                 │
└─────────────────────────────────────────┘
```

**技术实现**:
1. Tauri创建透明窗口（`transparent: true`, `always_on_top: true`）
2. 设置鼠标事件穿透（`set_ignore_cursor_events(true)`）
3. Python Sidecar使用pynput捕获鼠标位置
4. pywinauto/pyobjc获取元素信息
5. 通过Tauri事件系统实时更新高亮边框

---

### 4. 工作流执行

#### 4.1 执行界面

```
┌─────────────────────────────────────────┐
│ 执行: 数据采集工作流                     │
│ ████████████████░░░░ 80%                │
│ 预计剩余: 2分钟                          │
│                                         │
│ ┌─ 执行时间线 ─────────────────────────┐│
│ │ ✅ 1. Click - 点击登录 (0.5s)        ││
│ │ ✅ 2. Input - 输入用户名 (0.8s)      ││
│ │ ✅ 3. Input - 输入密码 (0.6s)        ││
│ │ ✅ 4. Click - 点击登录按钮 (1.2s)    ││
│ │ 🟡 5. HTTP请求 - 获取数据 (执行中)   ││
│ │ ⏸ 6. Data Extract - 提取数据        ││
│ │ ⏸ 7. File Operation - 保存文件      ││
│ └─────────────────────────────────────┘│
│                                         │
│ ┌─ 实时日志 ───────────────────────────┐│
│ │ 10:35:25 [INFO] 节点5开始执行        ││
│ │ 10:35:26 [INFO] 发送HTTP请求...      ││
│ │ 10:35:27 [INFO] 等待响应...          ││
│ │ ▌                                    ││
│ └─────────────────────────────────────┘│
│                                         │
│ [⏸ 暂停] [⏹ 终止] [📊 查看变量]        │
└─────────────────────────────────────────┘
```

#### 4.2 执行结果

```
┌─────────────────────────────────────────┐
│ ✅ 执行成功                              │
│ 开始: 10:30:15 | 结束: 10:42:08         │
│ 总耗时: 11分53秒                         │
│                                         │
│ ┌─ 执行统计 ───────────────────────────┐│
│ │ 总节点数: 10个                        ││
│ │ 成功: 10个 | 失败: 0个 | 跳过: 0个    ││
│ └─────────────────────────────────────┘│
│                                         │
│ ┌─ 输出结果 ───────────────────────────┐│
│ │ {                                    ││
│ │   "total": 150,                      ││
│ │   "success": 148,                    ││
│ │   "data": [...]                      ││
│ │ }                                    ││
│ │ [📋 复制] [📥 下载]                  ││
│ └─────────────────────────────────────┘│
│                                         │
│ [🔄 重新执行] [📊 查看详情] [🗑 删除]   │
└─────────────────────────────────────────┘
```

---

### 5. 任务队列管理

#### 任务列表

```
┌─────────────────────────────────────────┐
│ 任务队列                [全部暂停] [清空] │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│ 执行中 (2个)                            │
│ ┌─────────────────────────────────────┐ │
│ │ 📋 数据采集工作流    🟡 执行中 80%   │ │
│ │ 预计剩余: 2分钟                      │ │
│ │ [⏸ 暂停] [⏹ 终止] [📊 查看]        │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 等待中 (3个)                            │
│ ┌─────────────────────────────────────┐ │
│ │ 1️⃣ 📊 周报生成  🔴高  ⏳等待中      │ │
│ │ [▶️ 立即执行] [🗑 取消]             │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ 2️⃣ 📋 数据同步  🟡中  ⏳等待中      │ │
│ │ [▶️ 立即执行] [🗑 取消]             │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

### 6. 系统设置

#### 主设置页面

```
┌─────────────────────────────────────────┐
│ ⚙️ 设置                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│ ┌─ 左侧导航 ──┬─ 右侧内容 ─────────────┐│
│ │ 账号设置    │ 账号信息               ││
│ │ 应用绑定    │ 邮箱: user@example.com ││
│ │ 权限管理    │ 用户名: username       ││
│ │ 数据安全    │ 会员等级: 免费版       ││
│ │ 系统信息    │                        ││
│ │ 日志管理    │ [修改密码] [编辑资料]  ││
│ │ 通知设置    │                        ││
│ │ 更新服务    │                        ││
│ └─────────────┴────────────────────────┘│
└─────────────────────────────────────────┘
```

---

## 开发计划

### 时间线（3个月）

#### 第1个月：基础架构与核心能力

**Week 1-2: 项目初始化**
- [ ] Tauri 2 + React项目搭建
- [ ] Python Sidecar框架搭建
- [ ] 通信机制实现（IPC/HTTP）
- [ ] 本地数据库设计（SQLite）
- [ ] 基础UI框架（Tailwind + Shadcn UI）
- [ ] 用户认证UI与逻辑

**Week 3-4: 工作流设计器基础**
- [ ] React Flow集成
- [ ] 无限画布实现
- [ ] 节点库UI（左侧面板）
- [ ] 节点配置面板UI（右侧面板）
- [ ] 实现前7个UI自动化节点
- [ ] 工作流保存与加载

---

#### 第2个月：智能录制器与节点完善

**Week 5-6: 智能录制器**
- [ ] 叠加窗口实现
- [ ] Python元素识别（pywinauto/pyobjc）
- [ ] pynput键鼠监听
- [ ] 实时元素高亮
- [ ] 录制功能（启动、暂停、停止）
- [ ] 自动生成工作流节点

**Week 7-8: 节点完善与执行引擎**
- [ ] 实现流程控制节点（3个）
- [ ] 实现集成节点（2个）
- [ ] 实现文件操作节点（2个）
- [ ] 实现系统操作节点（3个）
- [ ] 工作流执行引擎核心逻辑
- [ ] 变量作用域管理
- [ ] 错误处理与重试机制

---

#### 第3个月：任务管理与系统完善

**Week 9-10: 任务管理**
- [ ] 任务队列实现
- [ ] 任务执行UI（实时日志、进度）
- [ ] 暂停/恢复/终止执行
- [ ] 执行结果详情页面
- [ ] 通知触发器实现
- [ ] 工作流管理页面

**Week 11-12: 系统功能与优化**
- [ ] 系统信息展示
- [ ] 日志管理功能
- [ ] 通知中心
- [ ] 更新服务集成
- [ ] 系统软件扫描
- [ ] 元素定位策略完善
- [ ] Playwright集成（Web自动化）
- [ ] 性能优化与Bug修复

---

## 验收标准

### 功能性验收

#### 1. 用户认证
- [ ] 用户可以注册、登录、退出
- [ ] 支持邮箱和第三方登录
- [ ] Token自动刷新正常

#### 2. 工作流设计
- [ ] 可以创建新工作流
- [ ] 可以拖拽添加节点
- [ ] 可以连接节点形成流程
- [ ] 可以配置节点参数
- [ ] 可以保存和加载工作流
- [ ] 支持撤销/重做

#### 3. 智能录制
- [ ] 可以启动录制模式
- [ ] 鼠标移动时实时高亮元素
- [ ] 可以选择和确认元素
- [ ] 操作可以被正确捕获
- [ ] 录制结束后自动生成工作流

#### 4. 工作流执行
- [ ] 工作流可以手动执行
- [ ] 显示实时日志和进度
- [ ] 可以暂停/恢复/终止
- [ ] 执行完成后显示详细结果
- [ ] 变量在节点间正确传递

#### 5. 元素定位
- [ ] AXUI定位在Windows和macOS正常工作
- [ ] OCR定位可以识别文字
- [ ] Image定位可以识别图片
- [ ] 支持多策略降级

#### 6. 节点功能
- [ ] 所有17个核心节点功能正常
- [ ] Click节点支持单击/双击/右键
- [ ] Input节点支持清空和输入
- [ ] Variable节点支持变量操作
- [ ] Compare节点支持条件分支
- [ ] HTTP Request节点支持GET/POST

---

### 性能验收

#### 1. 启动性能
- [ ] 应用冷启动 < 3秒
- [ ] 热启动 < 1秒

#### 2. 运行性能
- [ ] 空闲内存占用 < 200MB
- [ ] 执行工作流内存占用 < 500MB
- [ ] UI操作响应 < 100ms

#### 3. 工作流执行
- [ ] 简单工作流(<10节点) < 5秒
- [ ] 元素定位成功率 > 90%
- [ ] 工作流执行成功率 > 90%

---

### 兼容性验收

#### 1. 操作系统
- [ ] Windows 10/11 正常运行
- [ ] macOS 11.0+ 正常运行
- [ ] 支持不同分辨率（1280x720至4K）

#### 2. 浏览器自动化
- [ ] 支持Chrome浏览器
- [ ] 支持Edge浏览器
- [ ] 持久化上下文保持登录

---

## 技术架构

### 前端技术栈
- 框架: Tauri 2
- UI库: React 18 + TypeScript
- 状态管理: Zustand
- 工作流引擎: React Flow
- 样式: Tailwind CSS
- UI组件: Shadcn UI

### 后端引擎（Python Sidecar）
- 运行模式: 常驻进程（stdin/stdout IPC通信）
- GUI自动化: pywinauto (Windows) / pyobjc (macOS)
- 键鼠监听: pynput
- Web自动化: Playwright
- OCR: pytesseract
- 图像识别: opencv-python
- 打包: PyInstaller

### 数据存储
- 本地数据库: SQLite
- 配置文件: JSON
- 敏感数据: 系统Keychain/Credential Manager

---

**下一步**: 查看 [Phase 1 UI设计文档](./pc-ui-design.md)
