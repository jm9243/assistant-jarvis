# 架构统一说明

**文档版本**: V1.0  
**更新日期**: 2025-11-12  
**状态**: ✅ 已完成

---

## 概述

本文档说明了基于《PC端架构重构方案》对所有迭代计划文档进行的架构统一更新。

---

## 核心架构决策

### 1. Python引擎通信方式

**决策**: 使用**常驻进程 + stdin/stdout IPC通信**

**影响范围**:
- ✅ Phase 1: 工作流系统
- ✅ Phase 2: Agent系统
- ✅ Phase 3: 语音通话
- ✅ Phase 4: Multi-Agent协同
- ✅ Phase 5: 管理后台（不涉及）
- ✅ Phase 6: 移动端（不涉及）

**已更新文档**:
- `docs/plan/00-overview/product-overview.md`
- `docs/plan/phase-1-workflow/pc-client.md`

**关键变更**:
- ❌ 移除：FastAPI HTTP服务器
- ❌ 移除：端口8000占用
- ✅ 采用：常驻进程模式
- ✅ 采用：stdin/stdout IPC通信
- ✅ 性能：延迟从50-100ms降至~3ms

---

### 2. Agent系统实现

**决策**: 使用**自研Agent系统**（不使用AgentScope）

**影响范围**:
- ✅ Phase 2: Agent系统
- ✅ Phase 4: Multi-Agent协同

**已更新文档**:
- `docs/plan/phase-2-agent/pc-client.md`

**关键变更**:
- ❌ 移除：AgentScope框架依赖
- ❌ 移除：AgentScope学习曲线风险
- ❌ 移除：AgentScope资源链接
- ✅ 采用：自研Agent系统（BasicAgent、ReActAgent、Deep Research Agent）
- ✅ 优势：已与知识库（Chroma）、记忆系统、Go后台深度集成
- ✅ 优势：代码量更少，易于维护

---

### 3. 知识库向量存储

**决策**: 使用**Chroma本地向量数据库**（不使用pgvector）

**影响范围**:
- ✅ Phase 2: Agent系统（知识库）

**已更新文档**:
- `docs/plan/phase-2-agent/pc-client.md`
- `docs/plan/phase-2-agent/backend-service.md`

**关键变更**:
- ❌ 移除：pgvector（PostgreSQL扩展）
- ❌ 移除：云端向量存储
- ✅ 采用：Chroma本地向量数据库
- ✅ 优势：隐私保护（数据保存在本地）
- ✅ 优势：性能优化（无网络延迟）
- ✅ 优势：成本控制（无云端费用）
- ✅ 优势：轻量部署（易于集成）

**架构调整**:
- Go后台：仅存储知识库元数据
- PC端Python引擎：存储向量数据（Chroma）
- 检索方式：Go后台代理PC端Chroma检索

---

## 各阶段架构说明

### Phase 1: 工作流系统 ✅ 已实现

**架构特点**:
- Python常驻进程 + Tauri IPC通信
- GUI自动化（pywinauto/pyobjc）
- Web自动化（Playwright）
- 工作流执行引擎

**文档状态**: ✅ 已更新

---

### Phase 2: Agent系统 ✅ 已实现

**架构特点**:
- 自研Agent系统（BasicAgent、ReActAgent）
- Chroma本地向量数据库
- 知识库与记忆系统深度集成
- Go后台提供Agent配置管理API

**文档状态**: ✅ 已更新

**关键更新**:
- 架构图：AgentScope → 自研Agent系统
- 技术栈：pgvector → Chroma
- 风险管理：移除AgentScope学习曲线风险
- 附录：移除AgentScope资源，添加自研Agent说明

---

### Phase 3: 语音通话 🚧 待实现

**架构特点**:
- 基于Phase 1-2的架构
- 通话功能作为Python引擎扩展模块
- 虚拟音频设备集成
- 阿里云智能媒体服务集成

**文档状态**: ✅ 已添加架构说明

**架构依赖**:
- ✅ Python常驻进程（已实现）
- ✅ Tauri IPC通信（已实现）
- ✅ Agent系统（已实现）

---

### Phase 4: Multi-Agent协同 🚧 待实现

**架构特点**:
- 基于Phase 2的自研Agent系统
- Multi-Agent协同逻辑在PC端实现
- Go后台提供协同数据存储和管理API
- 不引入新的Agent框架

**文档状态**: ✅ 已添加架构说明

**架构依赖**:
- ✅ 自研Agent系统（已实现）
- ✅ BasicAgent和ReActAgent（已实现）

---

### Phase 5: 管理后台 🚧 待实现

**架构特点**:
- 纯Web应用（React + Ant Design Pro）
- Go后台提供管理API
- Supabase存储管理员账户和审计日志
- 不涉及PC端Python引擎

**文档状态**: ✅ 已添加架构说明

**架构依赖**:
- ✅ Go后台API（已实现）
- ✅ Supabase数据库（已实现）

---

### Phase 6: 移动端 📋 未来计划

**架构特点**:
- 纯监控和管理应用
- 通过Go后台API与PC端通信
- WebSocket实时推送
- 不执行自动化任务

**文档状态**: ✅ 已添加架构说明

**架构依赖**:
- ✅ Go后台API（已实现）
- ✅ WebSocket推送（已实现）

---

## 文档更新清单

### 已更新的文档

#### 产品概览
- ✅ `docs/plan/00-overview/product-overview.md`
  - 更新：Python引擎通信方式

#### Phase 1: 工作流系统
- ✅ `docs/plan/phase-1-workflow/pc-client.md`
  - 更新：Python引擎运行模式

#### Phase 2: Agent系统
- ✅ `docs/plan/phase-2-agent/pc-client.md`
  - 更新：架构图（AgentScope → 自研Agent）
  - 更新：技术栈说明
  - 更新：开发任务
  - 更新：风险管理
  - 更新：附录（移除AgentScope，添加自研Agent说明）

- ✅ `docs/plan/phase-2-agent/backend-service.md`
  - 更新：知识库架构（pgvector → Chroma）
  - 更新：数据库Schema（移除向量表）
  - 更新：检索API（代理模式）
  - 更新：技术架构图
  - 更新：风险管理
  - 更新：附录（移除pgvector，添加Chroma说明）

#### Phase 3: 语音通话
- ✅ `docs/plan/phase-3-voice-call/pc-client.md`
  - 添加：架构说明

#### Phase 4: Multi-Agent协同
- ✅ `docs/plan/phase-4-multi-agent/pc-client.md`
  - 添加：架构说明

- ✅ `docs/plan/phase-4-multi-agent/backend-service.md`
  - 添加：架构说明

#### Phase 5: 管理后台
- ✅ `docs/plan/phase-5-admin/backend-service.md`
  - 添加：架构说明

#### Phase 6: 移动端
- ✅ `docs/plan/phase-6-mobile/mobile-app.md`
  - 添加：架构说明

---

## 架构一致性检查

### ✅ 已验证的一致性

1. **Python引擎通信方式**
   - ✅ 所有文档统一使用"常驻进程 + IPC通信"
   - ✅ 无FastAPI或HTTP服务器引用

2. **Agent系统实现**
   - ✅ 所有文档统一使用"自研Agent系统"
   - ✅ 无AgentScope框架引用

3. **知识库向量存储**
   - ✅ 所有文档统一使用"Chroma本地"
   - ✅ 无pgvector或云端向量库引用

4. **架构分层**
   - ✅ 前端：Tauri 2 + React（UI层）
   - ✅ Python引擎：常驻进程（执行层）
   - ✅ Go后台：API服务（云端层）
   - ✅ Supabase：数据存储（数据层）

---

## 后续维护

### 新增文档规范

当创建新的迭代计划文档时，请遵循以下规范：

1. **在文档开头添加架构说明**
   ```markdown
   **架构说明**: 
   - 本阶段基于[依赖的架构]
   - [关键架构特点]
   - [架构约束或限制]
   ```

2. **明确技术栈**
   - Python引擎：常驻进程 + IPC通信
   - Agent系统：自研Agent（BasicAgent、ReActAgent）
   - 知识库：Chroma本地向量数据库
   - 后台：Go + Supabase

3. **避免引入冲突的技术**
   - ❌ 不使用：AgentScope、LangChain（Agent框架）
   - ❌ 不使用：FastAPI、Flask（HTTP服务器）
   - ❌ 不使用：pgvector、Qdrant（云端向量库）

---

## 参考文档

- [PC端架构重构方案](../PC端架构重构方案.md)
- [产品需求文档-完整版](../产品需求文档-完整版.md)
- [电脑端-UI-UX设计文档](../电脑端-UI-UX设计文档.md)

---

**文档状态**: ✅ 已完成  
**最后更新**: 2025-11-12  
**维护者**: 技术团队
