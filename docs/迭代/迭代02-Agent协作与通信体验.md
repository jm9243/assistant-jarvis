# 助手-贾维斯 PRD · 迭代02：Agent协作与通信体验

> 覆盖第4.4-4.7章，聚焦Agent中心、多Agent协同、Jarvis 助理以及自动化通信助理。

### 4.4 Agent中心

#### 4.4.1 Agent类型

**Basic Agent（基础Agent）**
- **核心能力**: 直接调用LLM生成回复，支持多轮对话
- **适用场景**: 简单对话、客服问答、文本生成
- **配置项**: 
  - 模型选择（OpenAI、Claude、Coze、本地模型）
  - Temperature、Max Tokens、Top-P等参数
  - System Prompt自定义
  - 回复风格设定

**ReAct Agent（推理行动Agent）**
- **核心能力**: Thought-Action-Observation循环，支持工具调用和多步推理
- **适用场景**: 需要多步推理、需要调用工具的复杂任务
- **配置项**: 
  - 最大迭代次数
  - 工具选择策略
  - 思考链可见性
  - 超时控制

**Deep Research Agent（深度研究Agent）**
- **核心能力**: 自动拆解研究任务、多源信息检索、生成结构化报告
- **适用场景**: 复杂研究任务、信息整合、深度分析
- **配置项**: 
  - 研究深度级别
  - 信息源范围
  - 可信度阈值
  - 报告格式模板

#### 4.4.2 对话能力
- **会话管理**: 创建、列表、切换、删除、导出会话
- **记忆系统**: 
  - **短期记忆**: 当前对话上下文，滑动窗口机制
  - **长期记忆**: 跨会话知识保留，用户偏好记忆
  - **工作记忆**: 任务执行状态，临时变量存储
- **对话策略**: 
  - 支持用户打断Agent回复
  - 多模态输入（文本、图片、文件）
  - 流式输出实时返回
  - 引用溯源显示来源

#### 4.4.3 知识库集成
- **知识库类型**: 文档、网页、结构化数据、API数据源
- **检索策略**: 
  - 向量检索（语义相似度）
  - 关键词检索（全文搜索）
  - 混合检索（向量+关键词）
  - Rerank重排序
- **知识库管理**: 
  - 文档上传（拖拽、批量上传）
  - 支持格式：PDF、DOCX、XLSX、TXT、MD、HTML、PPT
  - 分块策略配置
  - 自动向量化处理
  - 检索效果测试
  - 统计分析

#### 4.4.4 工具调用能力
- **工具类型**: 
  - Workflow工具（调用工作流）
  - MCP工具（Model Context Protocol）
  - HTTP API工具
  - 系统工具（文件操作、Shell命令）
  - 内置工具（计算器、日期处理）
- **调用流程**: 
  - 自动调用：Agent自动决策
  - 审批调用：需人工审批
  - 手动调用：用户手动触发
- **工具审批机制**: 
  - 配置审批规则
  - 申请→审批→执行流程
  - 自动审批条件
  - 审批历史可追溯

#### 4.4.5 Agent管理
- **Agent配置**: 
  - 基本信息（名称、描述、头像、标签）
  - 模型配置
  - Prompt配置
  - 记忆配置
  - 知识库绑定
  - 工具绑定
  - 权限配置
- **Agent模板库**: 
  - 客服类、分析类、创作类、研究类、协作类模板
  - 从模板快速创建Agent
  - 支持模板自定义和保存
- **Agent监控面板**: 
  - 实时状态显示
  - 执行日志查看
  - 性能指标（响应时间、成功率、Token消耗）
  - 告警配置
- **Agent调试工具**: 
  - 逐步执行调试
  - 变量实时查看
  - Prompt调试测试
  - 工具调用链路追踪
  - 详细执行日志
  - 性能瓶颈分析
- **Agent评估系统**: 
  - 输出质量评估
  - 执行效率评估
  - 用户满意度统计
  - 自动评估打分
  - 生成评估报告

---

### 4.5 Multi-Agent协同

#### 4.5.1 协同模式一：工作流编排
- **顺序执行**: Agent按顺序协作完成任务
- **并行执行**: 多个Agent同时工作
- **条件分支**: 根据结果选择不同Agent
- **循环执行**: 重复调用直到满足条件
- **数据传递**: Agent之间传递数据
- **可视化编排**: 拖拽式工作流设计器
- **数据映射**: 配置输入输出映射关系
- **错误处理**: Agent失败的恢复机制

#### 4.5.2 协同模式二：组织架构
- **组织角色**: 
  - Director（总监）：最高决策层，分配任务给Manager
  - Manager（经理）：中层管理，分配任务给Employee
  - Employee（员工）：执行具体任务
- **任务分配流程**: 
  - 任务下发：上级向下级分配
  - 任务分解：Manager拆解为子任务
  - 任务执行：Employee执行
  - 结果上报：下级向上级汇报
  - 任务审核：上级审核完成情况
- **组织管理**: 
  - 创建组织结构
  - 配置层级和角色
  - 分配Agent到角色
  - 权限设置
  - 可视化组织架构图

#### 4.5.3 协同模式三：Supervisor + Sub Agent
- **Supervisor能力**: 
  - 任务分解：拆解为子任务
  - 智能分配：根据Sub Agent能力分配
  - 执行监控：实时监控执行状态
  - 质量审查：审查输出质量
  - 结果综合：汇总所有结果
- **Sub Agent角色**: 
  - 任务接收
  - 独立执行
  - 结果上报
  - 协同通信（可选）
- **工作流程**: 
  - 任务输入→分解→分配→并行执行→质量审查→结果综合→最终输出

#### 4.5.4 协同模式四：Multi-Agent会议
- **会议角色**: 
  - Moderator（主持人）：主持流程、分配发言权
  - Participants（参与者）：参与讨论的Agent
  - Observers（观察者）：只观察不发言
- **会议类型**: 
  - 自由讨论
  - 决策会议
  - 头脑风暴
  - 问题诊断
- **会议配置**: 
  - 会议主题
  - 参与Agent及角色
  - 最大轮次
  - 发言规则（轮流、举手、自由）
  - 终止条件
- **会议UI**: 
  - 实时会议界面（流式显示发言）
  - 会议历史页面
  - 会议纪要（决策、行动项、风险）

#### 4.5.5 Multi-Agent可视化
- **协同拓扑图**: 
  - 节点类型：Agent、Workflow、Tool、Knowledge Base
  - 连接类型：数据流、调用关系、引用关系
  - 实时更新：高亮当前执行节点
  - 布局算法：层次布局、力导向布局
- **消息流可视化**: 
  - 消息时间线
  - Agent泳道视图
  - 消息卡片（内容、类型、时间戳）
  - 实时模式显示新消息

---

### 4.6 AI助理"贾维斯"

#### 4.6.1 极简交互入口
- **全局搜索框**: 类似Spotlight的极简界面
- **快捷键唤出**: 可自定义全局快捷键
- **自然语言输入**: 直接输入任务描述
- **多模态输入**: 支持文本、语音、图片输入

#### 4.6.2 意图理解与执行
- **自然语言理解**: 理解用户意图并转换为执行计划
- **任务规划**: 将复杂任务拆解为步骤
- **工作流调用**: 自动调用或创建工作流执行任务
- **实时反馈**: 显示执行进度和中间结果
- **执行确认**: 关键操作前请求用户确认

#### 4.6.3 上下文管理
- **多轮对话**: 支持连续对话，理解上下文
- **任务上下文**: 保持当前任务的上下文信息
- **跨会话记忆**: 记住用户偏好和历史任务

---

### 4.7 自动化通信助理

#### 4.7.1 AI智能接听

**来电检测**
- **通知监听**: 监听系统和应用的来电通知
- **来电人识别**: 提取来电人信息
- **自动接听**: 检测到来电后自动接听（可配置规则）
- **接听规则**: 
  - "开会时自动接听"
  - "陌生号码由AI接听"
  - "特定联系人自动接听"
  - 时间段规则（工作时间、休息时间）

**阿里云智能媒体服务集成**
- **ASR（语音识别）**: 
  - 实时语音识别
  - 支持中文、英文等多语言
  - 自动标点
  - 采样率：16000Hz
- **TTS（语音合成）**: 
  - 实时语音合成
  - 多种发音人选择
  - 语速、音量可调
- **对话管理**: 
  - 支持打断（Interruption）
  - 静音检测
  - 自动挂断（静音超时）
  - 最大通话时长限制

**虚拟音频**
- **虚拟输入设备**: 将AI声音输入到通话应用
- **虚拟输出设备**: 捕获通话应用的声音输出
- **音频设备切换**: 自动切换系统默认音频设备
- **音频设备恢复**: 通话结束后恢复原设备
- **驱动安装**: 
  - Windows：VB-CABLE
  - macOS：BlackHole

**音频接管技术实现细节**：

这是整个AI通话功能的核心技术难点，通过虚拟音频设备实现音频流的完全接管和重定向。

1. **虚拟音频驱动安装**：
   - **Windows**：应用安装包中捆绑`VB-CABLE`安装程序
   - **macOS**：应用安装包中捆绑`BlackHole`安装程序
   - 首次设置AI通话功能时，引导用户完成一次性的驱动安装授权
   - 安装后系统会出现新的虚拟音频设备：
     - VB-CABLE Input（虚拟麦克风）
     - VB-CABLE Output（虚拟扬声器）

2. **来电监听与触发**：
   - Python引擎通过系统API持续监听通知：
     - Windows：`winrt-notifications`
     - macOS：`pyobjc`访问NSUserNotificationCenter
   - 匹配到"电话"、"微信"、"企业微信"等应用的"来电"或"语音通话"通知
   - AI Agent决策层根据用户配置的接听规则决定是否接听

3. **自动接听执行**：
   - 运行预先录制好的RPA工作流
   - 模拟点击目标应用的"接听"按钮
   - 使用GUI自动化工具（pywinauto/pyobjc）精确定位和点击

4. **音频重定向（核心流程）**：
   
   **步骤1：捕获对方声音**
   ```
   对方说话 → 通话应用 → 系统默认扬声器
                              ↓（切换）
                        VB-CABLE Input（虚拟麦克风）
                              ↓
                        Python引擎捕获音频流
                              ↓
                        阿里云ASR（语音识别）
   ```
   - Python引擎执行系统命令，将操作系统的**默认扬声器**切换为`VB-CABLE Input`
   - 此时对方的声音不再从物理音箱播放，而是被导入虚拟音频管道
   - Python使用`sounddevice`库从虚拟输入端读取音频流
   - 实时发送给阿里云ASR服务进行语音识别

   **步骤2：AI声音输出**
   ```
   AI Agent生成回复文本
          ↓
   阿里云TTS（语音合成）
          ↓
   Python引擎接收音频流
          ↓
   VB-CABLE Output（虚拟扬声器）
          ↓（切换）
   系统默认麦克风 → 通话应用 → 对方听到
   ```
   - Python引擎将操作系统的**默认麦克风**切换为`VB-CABLE Output`
   - AI Agent生成的回复文本发送给阿里云TTS服务
   - 接收合成的音频流，通过`sounddevice`库播放到虚拟输出端
   - 通话应用捕获虚拟麦克风的声音，传输给对方

   **完整音频闭环**：
   ```
   对方声音 → 物理扬声器 → VB-CABLE Input → Python引擎 → 阿里云ASR
                                                    ↓
                                                AI Agent决策
                                                    ↓
   对方听到 ← 物理麦克风 ← VB-CABLE Output ← Python引擎 ← 阿里云TTS
   ```

5. **设备切换命令**：
   - **macOS**：使用`SwitchAudioSource`命令行工具
     ```bash
     # 切换输出设备
     SwitchAudioSource -s "BlackHole 2ch"
     # 切换输入设备
     SwitchAudioSource -s "BlackHole 2ch" -t input
     ```
   - **Windows**：使用`nircmd`或Windows API
     ```bash
     # 切换默认播放设备
     nircmd setdefaultsounddevice "CABLE Input"
     # 切换默认录音设备
     nircmd setdefaultsounddevice "CABLE Output" 1
     ```

6. **通话结束恢复**：
   - 检测到通话结束（挂断通知、静音超时、最大时长）
   - 执行系统命令将音频设备恢复到原始状态
   - 保存通话记录和对话内容
   - 生成通话摘要并上报服务器

7. **异常处理**：
   - 虚拟设备未安装：提示用户安装驱动
   - 设备切换失败：记录错误日志，尝试恢复原设备
   - 音频流中断：自动重连，超过3次失败则挂断
   - 通话应用崩溃：检测到应用退出，立即恢复音频设备

**通话记录**
- **对话记录**: 完整的对话文字记录
- **通话时长**: 记录通话持续时间
- **挂断原因**: AI决定挂断、超时、错误、静音
- **会话ID**: 关联阿里云会话ID
- **上报服务器**: 将通话记录同步到云端
- **查看历史**: 在应用内查看历史通话记录
- **生成摘要**: AI自动生成通话摘要

#### 4.7.2 音频设备管理
- **设备检测**: 列出所有音频输入/输出设备
- **虚拟设备检测**: 检测虚拟音频设备是否安装
- **设备状态**: 显示当前使用的设备
- **设备配置**: 选择麦克风、扬声器、虚拟设备
- **自动切换**: 通话时自动切换到虚拟设备

#### 4.7.3 音频测试
- **虚拟音频测试**: 播放测试音频、录制测试、回环测试
- **阿里云服务测试**: Token获取、ASR、TTS、AI Agent测试

#### 4.7.4 通话统计
- **今日通话数**: 今天的通话次数
- **总通话时长**: 累计通话时长
- **平均通话时长**: 平均每次通话时长
- **接通率**: 成功接听的比例
- **通话历史**: 查看所有通话记录，支持筛选、搜索、导出

---
