# PC端架构重构方案（完整版）

## 文档信息

- **版本**: v2.0
- **日期**: 2024-11-12
- **状态**: 已修正
- **作者**: 技术团队
- **修订说明**: 
  - 移除AgentScope集成方案
  - 明确架构分工（Rust/Python/Go）
  - 保持现有Agent实现
  - 修正前端API调用方式

## 目录

1. [执行摘要](#执行摘要)
2. [当前架构问题](#当前架构问题)
3. [重构目标](#重构目标)
4. [技术方案](#技术方案)
5. [实施计划](#实施计划)
6. [风险管理](#风险管理)
7. [资源需求](#资源需求)
8. [验收标准](#验收标准)

---

## 执行摘要

### 核心决策

**采用常驻进程+IPC方案**，不使用PyO3，理由如下：

1. ✅ **已验证可行性** - POC测试显示性能优异（~3ms延迟，25倍性能提升）
2. ✅ **利用现有基础** - 已有PyInstaller打包流程，无需Python环境
3. ✅ **实现简单** - 不需要学习PyO3，开发周期短
4. ✅ **风险可控** - 技术成熟，跨平台兼容性好

### 预期收益

| 指标 | 当前 | 目标 | 提升 |
|------|------|------|------|
| 架构层级 | 4层 | 3层 | 简化25% |
| Python启动 | HTTP服务器 | 常驻进程 | 启动快50% |
| 调用延迟 | 50-100ms | 3-5ms | 快20-30倍 |
| 内存占用 | ~200MB | ~100MB | 减少50% |
| 端口占用 | 8000 | 无 | 安全性提升 |
| 代码量 | 基准 | -40% | 维护成本降低 |

### 实施周期

**总计: 3-4周**
- Week 1: Python引擎改造（常驻进程模式）
- Week 2: Rust层实现（进程管理+IPC）
- Week 3: 前端改造+集成测试
- Week 4: 优化+文档+发布

---

## 架构分工原则

### 为什么这样分工？

#### 1. 发挥各语言优势

**Rust（系统层）**：
- ✅ 系统编程能力强
- ✅ 高性能、内存安全
- ✅ 跨平台支持好
- ✅ 适合底层操作

**Python（AI/业务层）**：
- ✅ AI/ML生态丰富
- ✅ 开发效率高
- ✅ 库丰富（Chroma、文档解析等）
- ✅ 易于调试和迭代
- ✅ 适合快速变化的业务逻辑

**Go（云端服务）**：
- ✅ 并发性能好
- ✅ 适合Web服务
- ✅ 部署简单
- ✅ 适合API网关

#### 2. 性能不是瓶颈

| 操作 | 延迟 | 瓶颈在哪 |
|------|------|----------|
| Agent对话（LLM调用） | 1-3秒 | LLM API响应 |
| 知识库检索 | 50-200ms | 向量计算 |
| 记忆读取 | <1ms | 内存操作（已很快） |
| IPC通信 | 3ms | 已验证足够快 |

**结论**：Python的性能完全够用，瓶颈在外部服务（LLM API），不在Python本身。

#### 3. 降低复杂度

- 每层做自己擅长的事
- 减少跨语言调用
- 减少数据转换
- 提高开发效率

---

## 当前架构问题

### 问题清单


#### 1. 架构复杂度高

**现状**:
```
前端 → Rust → Python(HTTP) → Go后台 → LLM
```

**问题**:
- 4层架构，通信链路长
- Python HTTP服务器占用端口8000
- 多种通信协议（HTTP、WebSocket、IPC）
- 调试困难，错误追踪复杂

#### 2. Python引擎职责过重

**承担功能**:
- ✅ FastAPI HTTP服务器
- ✅ WebSocket实时通信
- ✅ Agent系统（自研）
- ⚠️ LLM服务（仅URL转发）
- ✅ 知识库管理
- ✅ 工作流引擎
- ⚠️ GUI自动化（未完全实现）

**问题**:
- 代码量大，维护成本高
- LLM转发无实际价值
- HTTP服务器开销大（~50-100ms）

#### 3. Rust层能力未充分利用

**当前功能**:
- ✅ 窗口管理
- ✅ Python进程启动/停止
- ✅ 系统密钥库操作

**缺失功能**:
- ❌ 系统信息获取
- ❌ 应用列表获取
- ❌ 文件操作
- ❌ 屏幕截图

#### 4. 性能瓶颈

| 操作 | 当前延迟 | 原因 |
|------|---------|------|
| GUI自动化调用 | 50-100ms | HTTP请求开销 |
| 系统信息获取 | 未实现 | - |
| 文件操作 | 通过HTTP | 序列化开销 |

---

## 重构目标

### 主要目标

1. **简化架构** - 减少层级，降低复杂度
2. **提升性能** - 减少通信开销，提高响应速度
3. **职责清晰** - 各层专注核心功能
4. **易于维护** - 减少代码量，提高可读性
5. **安全增强** - 不暴露本地端口

### 具体指标

| 目标 | 当前值 | 目标值 | 优先级 |
|------|--------|--------|--------|
| GUI调用延迟 | 50-100ms | <5ms | P0 |
| Python启动时间 | ~3s | <2s | P1 |
| 内存占用 | ~200MB | <100MB | P1 |
| 代码行数 | 基准 | -40% | P2 |
| 架构层级 | 4层 | 3层 | P0 |

---

## 技术方案

### 方案概述

**核心思路**: Python引擎改为常驻进程模式，通过stdin/stdout进行IPC通信



### 新架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    前端层 (React)                        │
│              UI渲染、用户交互、状态管理                   │
└─────────────────────────────────────────────────────────┘
         ↕ (Tauri IPC)
┌──────────────────────────────────────────────────────────┐
│                  Rust层 (Tauri 2)                        │
│                                                          │
│  ✅ 系统级功能：                                          │
│     • 窗口管理                                           │
│     • Python进程管理（启动/停止/重启）                   │
│     • IPC通信管理（stdin/stdout）                        │
│     • 系统信息获取                                       │
│     • 文件操作                                           │
│     • 屏幕截图                                           │
│     • 密钥库操作                                         │
└──────────────────────────────────────────────────────────┘
         ↕ (stdin/stdout IPC)
┌──────────────────────────────────────────────────────────┐
│              Python引擎 (常驻进程)                        │
│                                                          │
│  ✅ AI/业务逻辑：                                         │
│     • Agent系统（自研，保持现有实现）                     │
│       - BasicAgent（对话型）                             │
│       - ReActAgent（推理-行动型）                        │
│       - 集成知识库检索                                   │
│       - 集成记忆系统                                     │
│     • 知识库管理（Chroma本地）                           │
│       - 文档解析（PDF、Word等）                          │
│       - 向量化（Embedding）                              │
│       - 向量检索（混合检索）                             │
│     • 记忆系统（三层架构）                               │
│       - 短期记忆（对话历史）                             │
│       - 工作记忆（临时变量）                             │
│       - 长期记忆（通过Go后台存储）                       │
│     • 工作流执行引擎                                     │
│     • 文档解析服务                                       │
│                                                          │
│  ✅ 自动化功能：                                          │
│     • GUI自动化（pywinauto/pyobjc）                     │
│     • 元素定位                                           │
│     • 屏幕操作                                           │
│     • OCR识别                                            │
│     • 录制器                                             │
└──────────────────────────────────────────────────────────┘
         ↕ (HTTP - 仅必要时)
┌──────────────────────────────────────────────────────────┐
│                  云端后台 (Go)                            │
│                                                          │
│  ✅ 云端服务：                                            │
│     • LLM API代理（统一管理API Key）                     │
│     • 用户认证和授权                                     │
│     • 长期记忆存储（跨设备同步）                         │
│     • 工作流云端存储（跨设备同步）                       │
│     • 使用统计和配额管理                                 │
│     • 知识库元数据存储                                   │
└──────────────────────────────────────────────────────────┘
```

### 通信协议

#### IPC请求格式
```json
{
  "id": "uuid-1234-5678",
  "function": "locate_element",
  "args": {
    "type": "button",
    "text": "确定"
  }
}
```

#### IPC响应格式
```json
{
  "id": "uuid-1234-5678",
  "success": true,
  "result": {
    "x": 100,
    "y": 200,
    "width": 50,
    "height": 30,
    "found": true
  }
}
```

### 关键技术决策

#### 决策1: 不使用PyO3

**原因**:
- ❌ PyO3学习曲线陡峭
- ❌ Python环境打包复杂
- ❌ 跨平台兼容性问题
- ✅ 常驻进程+IPC已验证可行
- ✅ 性能足够好（~3ms）

#### 决策2: 使用PyInstaller打包

**原因**:
- ✅ 已有成熟的打包流程
- ✅ 客户端无需Python环境
- ✅ 依赖自动打包
- ✅ 跨平台支持好

#### 决策3: 不使用AgentScope

**原因**:
- ❌ 与现有知识库系统（Chroma）冲突
- ❌ 与现有记忆系统（三层架构）冲突
- ❌ 与Go后台集成困难
- ❌ 代码量不减反增（需要1150行适配代码）
- ✅ 现有Agent实现已经很完整（830行）
- ✅ 已与知识库、记忆系统深度集成
- ✅ 已与Go后台集成（长期记忆）
- ✅ 性能优异，易于维护

**保持现有实现**:
- BasicAgent（对话型）
- ReActAgent（推理-行动型）
- 知识库集成
- 记忆系统集成
- 工具调用机制

#### 决策4: 明确架构分工

**Rust层负责（系统级）**:
- 窗口管理
- Python进程管理
- IPC通信管理
- 系统信息获取
- 文件操作
- 屏幕截图
- 密钥库操作

**Python引擎负责（AI/业务逻辑）**:
- ✅ Agent系统（自研，保持现有实现）
- ✅ 知识库管理（Chroma本地）
- ✅ 记忆系统（短期+工作记忆）
- ✅ 工作流执行
- ✅ GUI自动化
- ✅ 录制器功能
- ✅ 文档解析

**Go后台负责（云端服务）**:
- ✅ LLM API代理
- ✅ 用户认证
- ✅ 长期记忆存储（云端同步）
- ✅ 工作流云端存储（云端同步）
- ✅ 使用统计和配额

**前端调用方式**:
- Agent对话 → Tauri IPC → Python引擎
- 知识库管理 → Tauri IPC → Python引擎
- GUI自动化 → Tauri IPC → Python引擎
- 工作流执行 → Tauri IPC → Python引擎
- 用户登录 → HTTP → Go后台
- 云端同步 → HTTP → Go后台

---

## 实施计划

### 总体时间线

```
Week 1          Week 2          Week 3          Week 4
│               │               │               │
├─ Python改造   ├─ Rust实现     ├─ 前端改造     ├─ 优化发布
│  • 常驻进程   │  • 进程管理   │  • API切换     │  • 性能优化
│  • IPC通信    │  • IPC实现    │  • 集成测试   │  • 文档完善
│  • 函数注册   │  • 命令封装   │  • 跨平台测试 │  • 代码审查
│  • PyInstaller│  • 错误处理   │               │  • 发布准备
└───────────────┴───────────────┴───────────────┴───────────────
```



### Week 1: Python引擎改造

#### 目标
将Python引擎从HTTP服务器模式改为常驻进程模式

#### 任务清单

**Day 1-2: 创建常驻进程框架**
- [ ] 创建 `engine/daemon.py` 主循环
- [ ] 实现 stdin/stdout IPC通信
- [ ] 实现请求解析和响应发送
- [ ] 添加日志记录

**Day 3-4: 函数注册和路由**
- [ ] 创建 `engine/function_registry.py`
- [ ] 注册Agent相关函数（使用现有Agent实现）
  - [ ] `agent_chat` - Agent对话
  - [ ] `create_conversation` - 创建会话
  - [ ] `get_conversation_history` - 获取历史
- [ ] 注册知识库函数
  - [ ] `kb_search` - 知识库检索
  - [ ] `kb_add_document` - 添加文档
- [ ] 注册GUI自动化函数
  - [ ] `locate_element` - 元素定位
  - [ ] `click_element` - 点击元素
  - [ ] `input_text` - 输入文本
- [ ] 注册工作流执行函数
  - [ ] `execute_workflow` - 执行工作流
- [ ] 注册录制器函数
  - [ ] `start_recording` - 开始录制
  - [ ] `stop_recording` - 停止录制
- [ ] 实现错误处理

**Day 5: PyInstaller配置**
- [ ] 创建 `jarvis-engine-daemon.spec`
- [ ] 配置依赖打包
  - [ ] 包含Chroma
  - [ ] 包含文档解析库（PyPDF2、python-docx等）
  - [ ] 包含GUI自动化库（pywinauto/pyobjc）
  - [ ] 排除FastAPI、uvicorn等HTTP服务器库
- [ ] 测试打包
- [ ] 验证所有功能正常

**Day 6-7: 测试和优化**
- [ ] 单元测试
- [ ] 性能测试
- [ ] 内存泄漏检测
- [ ] 错误场景测试

#### 交付物
- ✅ `engine/daemon.py` - 常驻进程主程序
- ✅ `engine/function_registry.py` - 函数注册表
- ✅ `jarvis-engine-daemon.spec` - PyInstaller配置
- ✅ `dist/jarvis-engine` - 可执行文件（macOS/Windows）
- ✅ 测试报告

#### 验收标准
- [ ] 进程启动时间 < 2秒
- [ ] 单次调用延迟 < 5ms
- [ ] 内存占用 < 100MB
- [ ] 100次连续调用无错误
- [ ] 可执行文件大小 < 50MB

---

### Week 2: Rust层实现

#### 目标
实现Python进程管理和IPC通信

#### 任务清单

**Day 1-2: 进程管理器**
- [ ] 创建 `src-tauri/src/python_process.rs`
- [ ] 实现进程启动/停止
- [ ] 实现stdin/stdout管道
- [ ] 实现响应处理线程
- [ ] 实现自动重启机制

**Day 3-4: 全局状态管理**
- [ ] 创建 `src-tauri/src/python_state.rs`
- [ ] 实现单例模式
- [ ] 实现请求队列
- [ ] 实现超时处理
- [ ] 实现并发控制

**Day 5-6: Tauri命令封装**
- [ ] 创建 `src-tauri/src/commands.rs`
- [ ] 实现 `locate_element` 命令
- [ ] 实现 `click_element` 命令
- [ ] 实现 `input_text` 命令
- [ ] 实现 `take_screenshot` 命令
- [ ] 实现 `execute_workflow` 命令

**Day 7: 集成和测试**
- [ ] 集成到 `main.rs`
- [ ] 配置资源路径
- [ ] 单元测试
- [ ] 集成测试

#### 交付物
- ✅ `src-tauri/src/python_process.rs` - 进程管理器
- ✅ `src-tauri/src/python_state.rs` - 全局状态
- ✅ `src-tauri/src/commands.rs` - Tauri命令
- ✅ 单元测试
- ✅ 集成测试

#### 验收标准
- [ ] 进程自动启动成功率 100%
- [ ] 进程崩溃自动重启 < 3秒
- [ ] 并发10个请求无阻塞
- [ ] 请求超时正确处理
- [ ] 内存无泄漏

---

### Week 3: 前端改造和集成

#### 目标
前端API切换，完成端到端集成

#### 任务清单

**Day 1-2: API切换**
- [ ] 创建 `frontend/src/services/backend.ts` - Go后台API（云端服务）
- [ ] 创建 `frontend/src/services/python.ts` - Python引擎API（本地服务）
- [ ] Agent对话使用Tauri命令 → Python引擎
- [ ] 知识库管理使用Tauri命令 → Python引擎
- [ ] GUI自动化使用Tauri命令 → Python引擎
- [ ] 工作流执行使用Tauri命令 → Python引擎
- [ ] 用户认证使用HTTP → Go后台
- [ ] 云端同步使用HTTP → Go后台

**Day 3-4: 功能测试**
- [ ] 工作流设计器测试
- [ ] 工作流执行测试
- [ ] 录制器测试
- [ ] Agent对话测试
- [ ] 知识库测试

**Day 5: 跨平台测试**
- [ ] macOS测试
- [ ] Windows测试
- [ ] 打包测试
- [ ] 安装测试

**Day 6-7: Bug修复**
- [ ] 修复发现的问题
- [ ] 性能优化
- [ ] 用户体验优化

#### 交付物
- ✅ 前端API服务层重构
- ✅ 功能测试报告
- ✅ 跨平台测试报告
- ✅ Bug列表和修复记录

#### 验收标准
- [ ] 所有功能正常工作
- [ ] macOS和Windows都能运行
- [ ] 无阻塞性Bug
- [ ] 性能达标

---

### Week 4: 优化和发布

#### 目标
性能优化、文档完善、发布准备

#### 任务清单

**Day 1-2: 性能优化**
- [ ] 性能基准测试
- [ ] 识别性能瓶颈
- [ ] 优化关键路径
- [ ] 内存优化
- [ ] 启动时间优化

**Day 3-4: 文档完善**
- [ ] 更新架构文档
- [ ] 更新开发文档
- [ ] 更新部署文档
- [ ] 编写迁移指南
- [ ] 编写故障排查指南

**Day 5: 代码审查**
- [ ] Rust代码审查
- [ ] Python代码审查
- [ ] 前端代码审查
- [ ] 安全审查

**Day 6-7: 发布准备**
- [ ] 创建发布分支
- [ ] 更新版本号
- [ ] 生成变更日志
- [ ] 打包发布版本
- [ ] 准备发布说明

#### 交付物
- ✅ 性能测试报告
- ✅ 完整文档
- ✅ 代码审查报告
- ✅ 发布包
- ✅ 发布说明

#### 验收标准
- [ ] 所有性能指标达标
- [ ] 文档完整准确
- [ ] 代码审查通过
- [ ] 发布包可用

---

## 风险管理

### 风险识别



| 风险 | 等级 | 概率 | 影响 | 缓解措施 |
|------|------|------|------|----------|
| Python进程崩溃 | 中 | 中 | 高 | 自动重启机制 + 错误日志 |
| IPC通信阻塞 | 中 | 低 | 高 | 超时机制 + 异步处理 |
| 跨平台兼容性 | 低 | 低 | 中 | 充分测试 + 条件编译 |
| 性能不达标 | 低 | 低 | 中 | POC已验证，风险低 |
| 功能回归 | 中 | 中 | 高 | 完整测试 + 灰度发布 |
| 开发延期 | 中 | 中 | 中 | 预留缓冲时间 |

### 风险应对

#### 风险1: Python进程崩溃

**缓解措施**:
```rust
// 自动重启机制
impl PythonProcess {
    pub fn ensure_alive(&mut self) -> Result<(), String> {
        if !self.is_alive() {
            log::warn!("Python process crashed, restarting...");
            self.restart()?;
        }
        Ok(())
    }
}
```

**监控**:
- 进程健康检查（每30秒）
- 崩溃日志记录
- 崩溃次数统计

#### 风险2: IPC通信阻塞

**缓解措施**:
```rust
// 超时机制
let response = tokio::time::timeout(
    Duration::from_secs(30),
    rx
).await?;
```

**监控**:
- 请求延迟监控
- 超时次数统计
- 队列长度监控

#### 风险3: 功能回归

**缓解措施**:
- 完整的回归测试套件
- 自动化测试
- 灰度发布策略

**测试清单**:
- [ ] 工作流设计器
- [ ] 工作流执行
- [ ] 录制器
- [ ] Agent对话
- [ ] 知识库管理
- [ ] 系统设置

---

## 资源需求

### 人力资源

| 角色 | 人数 | 投入时间 | 主要职责 |
|------|------|----------|----------|
| Rust开发 | 1 | 100% | Rust层实现 |
| Python开发 | 1 | 100% | Python引擎改造 |
| 前端开发 | 1 | 50% | 前端API切换 |
| 测试工程师 | 1 | 50% | 测试和验证 |
| 技术负责人 | 1 | 20% | 技术决策和审查 |

### 技术资源

**开发环境**:
- macOS开发机 x 1
- Windows开发机 x 1
- 测试设备若干

**工具和服务**:
- Git版本控制
- CI/CD流水线
- 性能监控工具
- 日志分析工具

---

## 验收标准

### 功能验收

#### 必须满足（P0）

- [ ] 所有现有功能正常工作
- [ ] 工作流设计和执行正常
- [ ] 录制器功能正常
- [ ] GUI自动化功能正常
- [ ] macOS和Windows都能运行

#### 应该满足（P1）

- [ ] Agent对话功能正常
- [ ] 知识库管理功能正常
- [ ] 系统设置功能正常
- [ ] 错误提示友好

#### 可以满足（P2）

- [ ] 性能监控面板
- [ ] 调试工具
- [ ] 日志查看器

### 性能验收

| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| GUI调用延迟 | < 5ms | 性能测试工具 |
| Python启动时间 | < 2s | 计时测试 |
| 内存占用 | < 100MB | 内存监控 |
| 应用启动时间 | < 3s | 计时测试 |
| 并发处理能力 | 10个请求 | 压力测试 |

### 质量验收

| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| 代码覆盖率 | > 70% | 单元测试 |
| 崩溃率 | < 0.1% | 稳定性测试 |
| 内存泄漏 | 0 | 长时间运行测试 |
| 跨平台兼容性 | 100% | 跨平台测试 |

---

## 回滚计划

### 回滚触发条件

- 严重Bug导致功能不可用
- 性能严重下降（>50%）
- 稳定性问题（崩溃率>1%）
- 跨平台兼容性问题

### 回滚步骤

1. **停止发布** - 立即停止新版本发布
2. **评估影响** - 评估问题影响范围
3. **决策回滚** - 技术负责人决定是否回滚
4. **执行回滚** - 恢复到上一个稳定版本
5. **问题分析** - 分析问题原因
6. **修复计划** - 制定修复计划

### 回滚准备

- [ ] 保留上一个稳定版本
- [ ] 准备回滚脚本
- [ ] 测试回滚流程
- [ ] 准备回滚通知

---

## 发布策略

### 灰度发布

**阶段1: 内部测试（Week 4 Day 1-2）**
- 开发团队使用
- 收集反馈
- 修复问题

**阶段2: Beta测试（Week 4 Day 3-4）**
- 10%用户
- 监控指标
- 收集反馈

**阶段3: 全量发布（Week 4 Day 5-7）**
- 100%用户
- 持续监控
- 快速响应

### 监控指标

**关键指标**:
- 崩溃率
- 启动成功率
- API调用成功率
- 平均响应时间
- 内存占用

**告警阈值**:
- 崩溃率 > 0.5%
- 启动失败率 > 1%
- API失败率 > 2%
- 响应时间 > 10ms
- 内存占用 > 150MB

---

## 后续优化

### 短期优化（1-2个月）

1. **Rust系统功能增强**
   - 实现系统信息获取
   - 实现应用列表获取
   - 实现文件操作
   - 实现屏幕截图

2. **性能持续优化**
   - 减少内存占用
   - 优化启动时间
   - 优化IPC通信

3. **用户体验优化**
   - 改进错误提示
   - 添加进度指示
   - 优化加载动画

### 中期优化（3-6个月）

1. **功能增强**
   - 完善GUI自动化
   - 增强元素定位
   - 支持更多自动化场景

2. **架构优化**
   - 评估是否需要更多Rust功能
   - 优化Python引擎
   - 改进错误处理

3. **工具完善**
   - 开发调试工具
   - 完善日志系统
   - 添加性能监控

---

## 附录

### A. 技术栈

**前端**:
- React 18
- TypeScript
- Zustand (状态管理)
- React Flow (工作流设计器)

**Rust层**:
- Tauri 2
- tokio (异步运行时)
- serde (序列化)
- uuid (ID生成)

**Python引擎**:
- Python 3.10+
- PyInstaller (打包)
- pywinauto (Windows GUI)
- pyobjc (macOS GUI)

**云端后台**:
- Go 1.21+
- Gin (Web框架)
- Supabase (数据库)



**文档版本**: v2.0  
**最后更新**: 2024-11-12  
**状态**: 已修正
